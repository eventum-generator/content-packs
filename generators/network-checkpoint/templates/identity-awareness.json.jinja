{%- set seq = shared.get('sequencenum', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set origin = params.gateway_ip -%}
{%- set operation = module.rand.weighted_choice(["Log In", "Log Out", "Update"], [50, 30, 20]) -%}
{%- set user = samples.users | random -%}
{%- set ws_hosts = [] -%}
{%- for h in samples.internal_hosts if h.subnet == "workstations" -%}
  {%- do ws_hosts.append(h) -%}
{%- endfor -%}
{%- set user_host = ws_hosts | random -%}
{%- set src_ip = user_host.ip -%}
{%- set identity_src = module.rand.weighted_choice(
  ["AD Query", "Captive Portal", "RADIUS", "Identity Agent"],
  [50, 20, 15, 15]
) -%}
{%- set auth_methods = {
  "AD Query": "User Authentication (Active Directory)",
  "Captive Portal": "User Authentication (Captive Portal)",
  "RADIUS": "User Authentication (RADIUS)",
  "Identity Agent": "User Authentication (Identity Agent)"
} -%}
{%- set auth_method = auth_methods[identity_src] -%}
{%- if operation == "Log In" -%}
  {%- set login_success = module.rand.chance(0.9) -%}
  {%- if login_success -%}
    {%- set action = "Log In" -%}
    {%- set event_action = "logged-in" -%}
    {%- set event_outcome = "success" -%}
    {%- set event_type_val = ["start"] -%}
    {%- set auth_status = "succeeded" -%}
  {%- else -%}
    {%- set action = "Failed Log In" -%}
    {%- set event_action = "logon-failed" -%}
    {%- set event_outcome = "failure" -%}
    {%- set event_type_val = ["start"] -%}
    {%- set auth_status = "failed" -%}
  {%- endif -%}
{%- elif operation == "Log Out" -%}
  {%- set action = "Log Out" -%}
  {%- set event_action = "logged-out" -%}
  {%- set event_outcome = "success" -%}
  {%- set event_type_val = ["end"] -%}
  {%- set auth_status = "succeeded" -%}
{%- else -%}
  {%- set action = "Update" -%}
  {%- set event_action = "Update" -%}
  {%- set event_outcome = "success" -%}
  {%- set event_type_val = ["info"] -%}
  {%- set auth_status = "succeeded" -%}
{%- endif -%}
{%- set ts_hex = "%x" | format(timestamp.timestamp() | int) -%}
{%- set loguid = "{0x%s,0x%s,0x%s,0x%s}" | format(ts_hex, module.rand.string.hex(1), module.rand.string.hex(8), "c" ~ module.rand.string.hex(7)) -%}
{%- do shared.set('sequencenum', (seq + 1) % 2147483647) -%}
{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ hostname }}.{{ domain }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "checkpoint": {
    "auth_method": "{{ auth_method }}",
    "auth_status": "{{ auth_status }}",
    "flags": "163872",
    "identity_src": "{{ identity_src }}",
    "identity_type": "user",
    "ifdir": "inbound",
    "ifname": "daemon",
    "logid": "0",
    "loguid": "{{ loguid }}",
    "operation": "{{ operation }}",
    "origin": "{{ origin }}",
    "origin_sic_name": "cn=cp_mgmt,o={{ hostname }}.{{ domain }}",
    "rule_action": "{{ action }}",
    "sequencenum": {{ seq }},
    "version": "5"
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "{{ event_action }}",
    "category": ["authentication"],
    "dataset": "checkpoint.firewall",
    "kind": "event",
    "module": "checkpoint",
    "outcome": "{{ event_outcome }}",
    "sequence": {{ seq }},
    "type": {{ event_type_val | tojson }}
  },
  "host": {
    "hostname": "{{ hostname }}"
  },
  "observer": {
    "name": "{{ origin }}",
    "product": "Identity Awareness",
    "type": "firewall",
    "vendor": "Checkpoint"
  },
  "related": {
    "ip": ["{{ src_ip }}"],
    "user": ["{{ user.username }}"]
  },
  "source": {
    "ip": "{{ src_ip }}",
    "user": {
      "domain": "{{ user.domain }}",
      "group": { "name": "{{ user.department }}" },
      "name": "{{ user.username }}"
    }
  },
  "user": {
    "domain": "{{ user.domain }}",
    "name": "{{ user.username }}"
  },
  "tags": ["checkpoint", "forwarded"]
}
