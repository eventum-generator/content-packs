{%- set seq = shared.get('sequencenum', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set origin = params.gateway_ip -%}
{%- set direction_type = module.rand.weighted_choice(["inbound", "outbound", "internal"], [80, 10, 10]) -%}
{%- set drop_services = [
  {"port": 445, "proto": 6, "name": "smb", "transport": "tcp"},
  {"port": 23, "proto": 6, "name": "telnet", "transport": "tcp"},
  {"port": 3389, "proto": 6, "name": "rdp", "transport": "tcp"},
  {"port": 22, "proto": 6, "name": "ssh", "transport": "tcp"},
  {"port": 1433, "proto": 6, "name": "mssql", "transport": "tcp"},
  {"port": 3306, "proto": 6, "name": "mysql", "transport": "tcp"},
  {"port": 443, "proto": 6, "name": "https", "transport": "tcp"},
  {"port": 80, "proto": 6, "name": "http", "transport": "tcp"},
  {"port": 161, "proto": 17, "name": "snmp", "transport": "udp"},
  {"port": 135, "proto": 6, "name": "rpc", "transport": "tcp"}
] -%}
{%- set service = module.rand.weighted_choice(drop_services, [20, 15, 15, 10, 8, 5, 10, 8, 5, 4]) -%}
{%- set drop_rules = [] -%}
{%- set drop_rule_weights = [] -%}
{%- for r in samples.firewall_rules if r.action == "Drop" -%}
  {%- do drop_rules.append(r) -%}
  {%- do drop_rule_weights.append(r.weight) -%}
{%- endfor -%}
{%- set rule = module.rand.weighted_choice(drop_rules, drop_rule_weights) -%}
{%- if direction_type == "inbound" -%}
  {%- set src_ip = module.rand.network.ip_v4_public() -%}
  {%- set dst_host = samples.internal_hosts | random -%}
  {%- set dst_ip = dst_host.ip -%}
  {%- set inzone = "External" -%}
  {%- set outzone = "Internal" -%}
  {%- set ifname = "eth1" -%}
{%- elif direction_type == "outbound" -%}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set src_ip = src_host.ip -%}
  {%- set dst_ip = module.rand.network.ip_v4_public() -%}
  {%- set inzone = "Internal" -%}
  {%- set outzone = "External" -%}
  {%- set ifname = "eth0" -%}
{%- else -%}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set src_ip = src_host.ip -%}
  {%- set dst_host = samples.internal_hosts | random -%}
  {%- set dst_ip = dst_host.ip -%}
  {%- set inzone = "Internal" -%}
  {%- set outzone = "Internal" -%}
  {%- set ifname = "eth0" -%}
{%- endif -%}
{%- set s_port = module.rand.number.integer(1024, 65535) -%}
{%- set proto_type = module.rand.weighted_choice(["tcp", "udp", "icmp"], [65, 25, 10]) -%}
{%- if proto_type == "icmp" -%}
  {%- set service = {"port": 0, "proto": 1, "name": "icmp", "transport": "icmp"} -%}
  {%- set s_port = 0 -%}
{%- endif -%}
{%- set ts_hex = "%x" | format(timestamp.timestamp() | int) -%}
{%- set loguid = "{0x%s,0x%s,0x%s,0x%s}" | format(ts_hex, module.rand.string.hex(1), module.rand.string.hex(8), "c" ~ module.rand.string.hex(7)) -%}
{%- do shared.set('sequencenum', (seq + 1) % 2147483647) -%}
{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ hostname }}.{{ domain }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "checkpoint": {
    "flags": "393216",
    "ifdir": "inbound",
    "ifname": "{{ ifname }}",
    "logid": "0",
    "loguid": "{{ loguid }}",
    "match_id": "{{ rule.rule_num }}",
    "origin": "{{ origin }}",
    "origin_sic_name": "cn=cp_mgmt,o={{ hostname }}.{{ domain }}",
    "parent_rule": "0",
    "rule": "{{ rule.rule_num }}",
    "rule_action": "Drop",
    "rule_uid": "{{ rule.rule_uid }}",
    "sequencenum": {{ seq }},
    "version": "5",
    "layer_name": "{{ rule.layer_name }}",
    "layer_uuid": "{{ rule.layer_uuid }}"
  },
  "destination": {
    "ip": "{{ dst_ip }}",
    "port": {{ service.port }}
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "Drop",
    "category": ["network"],
    "dataset": "checkpoint.firewall",
    "kind": "event",
    "module": "checkpoint",
    "outcome": "success",
    "sequence": {{ seq }},
    "type": ["connection", "denied"]
  },
  "host": {
    "hostname": "{{ hostname }}"
  },
  "network": {
    "application": "{{ service.name }}",
    "direction": "{{ direction_type }}",
    "iana_number": "{{ service.proto }}",
    "name": "{{ rule.layer_name }}",
    "transport": "{{ service.transport }}"
  },
  "observer": {
    "egress": {
      "interface": { "name": "{{ ifname }}" },
      "zone": "{{ outzone }}"
    },
    "ingress": {
      "interface": { "name": "{{ ifname }}" },
      "zone": "{{ inzone }}"
    },
    "name": "{{ origin }}",
    "product": "VPN-1 & FireWall-1",
    "type": "firewall",
    "vendor": "Checkpoint"
  },
  "related": {
    "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
  },
  "rule": {
    "id": "{{ rule.rule_num }}",
    "name": "{{ rule.rule_name }}",
    "uuid": "{{ rule.rule_uid }}"
  },
  "source": {
    "ip": "{{ src_ip }}",
    "port": {{ s_port }}
  },
  "tags": ["checkpoint", "forwarded"]
}
