{%- set seq = shared.get('sequencenum', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set origin = params.gateway_ip -%}
{%- set av_sigs = [] -%}
{%- set av_weights = [] -%}
{%- for s in samples.malware_signatures if s.blade == "anti_virus" -%}
  {%- do av_sigs.append(s) -%}
  {%- do av_weights.append(s.weight) -%}
{%- endfor -%}
{%- set sig = module.rand.weighted_choice(av_sigs, av_weights) -%}
{%- set action = module.rand.weighted_choice(["Prevent", "Detect", "Monitor"], [50, 35, 15]) -%}
{%- set direction_type = module.rand.weighted_choice(["inbound", "outbound"], [70, 30]) -%}
{%- if direction_type == "inbound" -%}
  {%- set src_ip = module.rand.network.ip_v4_public() -%}
  {%- set dst_host = samples.internal_hosts | random -%}
  {%- set dst_ip = dst_host.ip -%}
  {%- set inzone = "External" -%}
  {%- set outzone = "Internal" -%}
{%- else -%}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set src_ip = src_host.ip -%}
  {%- set dst_ip = module.rand.network.ip_v4_public() -%}
  {%- set inzone = "Internal" -%}
  {%- set outzone = "External" -%}
{%- endif -%}
{%- set s_port = module.rand.number.integer(1024, 65535) -%}
{%- set d_port = module.rand.weighted_choice([80, 443, 8080], [40, 45, 15]) -%}
{%- set file_names = ["invoice.pdf", "report.docx", "update.exe", "document.xlsx", "setup.msi", "archive.zip", "image.png.exe"] -%}
{%- set file_name = file_names | random -%}
{%- set file_ext = file_name.rsplit(".", 1)[-1] -%}
{%- set file_md5 = module.rand.string.hex(32) -%}
{%- set file_sha256 = module.rand.string.hex(64) -%}
{%- set file_size = module.rand.number.integer(1024, 5242880) -%}
{%- set severity_map = {"Critical": 4, "High": 3, "Medium": 2, "Low": 1} -%}
{%- set severity_num = severity_map.get(sig.severity, 2) -%}
{%- set ts_hex = "%x" | format(timestamp.timestamp() | int) -%}
{%- set loguid = "{0x%s,0x%s,0x%s,0x%s}" | format(ts_hex, module.rand.string.hex(1), module.rand.string.hex(8), "c" ~ module.rand.string.hex(7)) -%}
{%- do shared.set('sequencenum', (seq + 1) % 2147483647) -%}
{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ hostname }}.{{ domain }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "checkpoint": {
    "confidence_level": "{{ sig.confidence }}",
    "flags": "147456",
    "ifdir": "{{ 'inbound' if direction_type == 'inbound' else 'outbound' }}",
    "ifname": "{{ 'eth1' if direction_type == 'inbound' else 'eth0' }}",
    "logid": "0",
    "loguid": "{{ loguid }}",
    "malware_action": "{{ sig.action_desc }}",
    "malware_family": "{{ sig.family }}",
    "origin": "{{ origin }}",
    "origin_sic_name": "cn=cp_mgmt,o={{ hostname }}.{{ domain }}",
    "protection_name": "{{ sig.name }}",
    "protection_type": "Anti-Virus",
    "rule_action": "{{ action }}",
    "sequencenum": {{ seq }},
    "severity": "{{ sig.severity }}",
    "version": "5"
  },
  "destination": {
    "ip": "{{ dst_ip }}",
    "port": {{ d_port }}
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "{{ action }}",
    "category": ["network", "malware"],
    "dataset": "checkpoint.firewall",
    "kind": "alert",
    "module": "checkpoint",
    "outcome": "success",
    "sequence": {{ seq }},
    "severity": {{ severity_num }},
    "type": ["connection"{% if action == "Prevent" %}, "denied"{% endif %}]
  },
  "file": {
    "hash": {
      "md5": "{{ file_md5 }}",
      "sha256": "{{ file_sha256 }}"
    },
    "name": "{{ file_name }}",
    "size": {{ file_size }},
    "type": "{{ file_ext }}"
  },
  "host": {
    "hostname": "{{ hostname }}"
  },
  "network": {
    "application": "{{ 'https' if d_port == 443 else 'http' }}",
    "direction": "{{ direction_type }}",
    "iana_number": "6",
    "transport": "tcp"
  },
  "observer": {
    "egress": { "zone": "{{ outzone }}" },
    "ingress": { "zone": "{{ inzone }}" },
    "name": "{{ origin }}",
    "product": "New Anti Virus",
    "type": "firewall",
    "vendor": "Checkpoint"
  },
  "related": {
    "hash": ["{{ file_md5 }}", "{{ file_sha256 }}"],
    "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
  },
  "rule": {
    "description": "{{ sig.action_desc }}",
    "name": "{{ sig.name }}"
  },
  "source": {
    "ip": "{{ src_ip }}",
    "port": {{ s_port }}
  },
  "tags": ["checkpoint", "forwarded"]
}
