{%- set host = samples.hosts | random -%}
{%- set hostname = host.name -%}
{%- set domain = params.domain -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{%- set record_id = shared.get('record_id:' ~ hostname, 1) -%}
{%- set domain_sid = params.domain_sid -%}
{%- set subject_user = "Administrator" -%}
{%- set subject_sid = domain_sid ~ "-500" -%}
{%- set subject_logon_id = "0x" ~ module.rand.string.hex(5) -%}
{#- Member being added -#}
{%- set member_user = (samples.usernames | random).username -%}
{%- set member_sid = domain_sid ~ "-" ~ module.rand.number.integer(1100, 9999) -%}
{#- Target group -#}
{%- set group_idx = module.rand.weighted_choice([0, 1, 2, 3, 4], [40, 25, 15, 10, 10]) -%}
{%- set groups = [
  {"name": "Administrators", "sid": "S-1-5-32-544", "domain": "Builtin"},
  {"name": "Remote Desktop Users", "sid": "S-1-5-32-555", "domain": "Builtin"},
  {"name": "Event Log Readers", "sid": "S-1-5-32-573", "domain": "Builtin"},
  {"name": "Backup Operators", "sid": "S-1-5-32-551", "domain": "Builtin"},
  {"name": "Performance Monitor Users", "sid": "S-1-5-32-558", "domain": "Builtin"}
] -%}
{%- set group = groups[group_idx] -%}
{%- set process_id = module.rand.number.integer(4, 65535) -%}
{%- set thread_id = module.rand.number.integer(1, 8191) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ host.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "winlogbeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "added-member-to-group",
        "category": ["iam"],
        "code": "4732",
        "kind": "event",
        "module": "security",
        "outcome": "success",
        "provider": "Microsoft-Windows-Security-Auditing",
        "type": ["group", "change"]
    },
    "group": {
        "domain": "{{ group.domain }}",
        "id": "{{ group.sid }}",
        "name": "{{ group.name }}"
    },
    "host": {
        "name": "{{ hostname }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "log": {
        "level": "information"
    },
    "related": {
        "user": ["{{ subject_user }}", "{{ member_user }}"]
    },
    "user": {
        "domain": "{{ domain }}",
        "id": "{{ subject_sid }}",
        "name": "{{ subject_user }}",
        "target": {
            "domain": "{{ domain }}",
            "name": "{{ member_user }}"
        }
    },
    "winlog": {
        "channel": "Security",
        "computer_name": "{{ fqdn }}",
        "event_data": {
            "MemberName": "CN={{ member_user }},CN=Users,DC={{ domain | lower }},DC=local",
            "MemberSid": "{{ member_sid }}",
            "PrivilegeList": "-",
            "SubjectDomainName": "{{ domain }}",
            "SubjectLogonId": "{{ subject_logon_id }}",
            "SubjectUserName": "{{ subject_user }}",
            "SubjectUserSid": "{{ subject_sid }}",
            "TargetDomainName": "{{ group.domain }}",
            "TargetSid": "{{ group.sid }}",
            "TargetUserName": "{{ group.name }}"
        },
        "event_id": "4732",
        "keywords": ["Audit Success"],
        "level": "information",
        "opcode": "Info",
        "outcome": "success",
        "process": {
            "pid": {{ process_id }},
            "thread": {
                "id": {{ thread_id }}
            }
        },
        "provider_guid": "{54849625-5478-4994-A5BA-3E3B0328C30D}",
        "provider_name": "Microsoft-Windows-Security-Auditing",
        "record_id": "{{ record_id }}",
        "task": "Security Group Management",
        "time_created": "{{ timestamp.isoformat() }}"
    }
}
{%- do shared.set('record_id:' ~ hostname, (record_id + 1) % 2147483647) -%}
