{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{#- Source process (the injecting process) -#}
{%- set proc_pool = shared.get('proc_pool', []) -%}
{%- if proc_pool | length > 1 -%}
  {%- set src_proc = proc_pool | random -%}
  {#- Target process (different from source) -#}
  {%- set tgt_candidates = [] -%}
  {%- for p in proc_pool -%}
    {%- if p.guid != src_proc.guid -%}
      {%- do tgt_candidates.append(p) -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if tgt_candidates | length > 0 -%}
    {%- set tgt_proc = tgt_candidates | random -%}
  {%- else -%}
    {%- set tgt_proc = proc_pool | random -%}
  {%- endif -%}
  {%- set source_guid = src_proc.guid -%}
  {%- set source_pid = src_proc.pid -%}
  {%- set source_image = src_proc.image -%}
  {%- set source_user = src_proc.user -%}
  {%- set target_guid = tgt_proc.guid -%}
  {%- set target_pid = tgt_proc.pid -%}
  {%- set target_image = tgt_proc.image -%}
  {%- set target_user = tgt_proc.user -%}
{%- else -%}
  {%- set src = samples.processes | random -%}
  {%- set tgt = samples.processes | random -%}
  {%- set source_guid = '{' ~ module.rand.crypto.uuid4() ~ '}' -%}
  {%- set source_pid = module.rand.number.integer(100, 65535) -%}
  {%- set source_image = src.path -%}
  {%- set source_user = domain ~ "\\" ~ (samples.usernames | random).username -%}
  {%- set target_guid = '{' ~ module.rand.crypto.uuid4() ~ '}' -%}
  {%- set target_pid = module.rand.number.integer(100, 65535) -%}
  {%- set target_image = tgt.path -%}
  {%- set target_user = "NT AUTHORITY\\SYSTEM" -%}
{%- endif -%}
{%- set new_thread_id = module.rand.number.integer(100, 65535) -%}
{%- set start_address = "0x" ~ module.rand.string.hex(16) | upper -%}
{%- set sysmon_pid = module.rand.number.integer(1000, 5000) -%}
{%- set sysmon_tid = module.rand.number.integer(1000, 8000) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "winlogbeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "CreateRemoteThread",
        "category": ["process"],
        "code": "8",
        "created": "{{ timestamp.isoformat() }}",
        "kind": "event",
        "module": "sysmon",
        "provider": "Microsoft-Windows-Sysmon",
        "type": ["change"]
    },
    "host": {
        "name": "{{ hostname }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "log": {
        "level": "information"
    },
    "process": {
        "entity_id": "{{ source_guid }}",
        "executable": "{{ source_image }}",
        "pid": {{ source_pid }}
    },
    "winlog": {
        "channel": "Microsoft-Windows-Sysmon/Operational",
        "computer_name": "{{ fqdn }}",
        "event_data": {
            "NewThreadId": "{{ new_thread_id }}",
            "SourceImage": "{{ source_image }}",
            "SourceProcessGuid": "{{ source_guid }}",
            "SourceProcessId": "{{ source_pid }}",
            "SourceUser": "{{ source_user }}",
            "StartAddress": "{{ start_address }}",
            "StartFunction": "",
            "StartModule": "",
            "TargetImage": "{{ target_image }}",
            "TargetProcessGuid": "{{ target_guid }}",
            "TargetProcessId": "{{ target_pid }}",
            "TargetUser": "{{ target_user }}"
        },
        "event_id": "8",
        "opcode": "Info",
        "process": {
            "pid": {{ sysmon_pid }},
            "thread": {
                "id": {{ sysmon_tid }}
            }
        },
        "provider_guid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}",
        "provider_name": "Microsoft-Windows-Sysmon",
        "record_id": "{{ record_id }}",
        "user": {
            "identifier": "S-1-5-18"
        },
        "version": 5
    }
}
{%- do shared.set('record_id', (record_id + 1) % 2147483647) -%}