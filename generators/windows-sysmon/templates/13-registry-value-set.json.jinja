{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{%- set domain_sid = params.domain_sid -%}
{#- Pick an active process (non-consuming) or fallback -#}
{%- set proc_pool = shared.get('proc_pool', []) -%}
{%- if proc_pool | length > 0 -%}
  {%- set active_proc = proc_pool | random -%}
  {%- set process_guid = active_proc.guid -%}
  {%- set process_id = active_proc.pid -%}
  {%- set process_image = active_proc.image -%}
  {%- set process_name = active_proc.name -%}
  {%- set user_name = active_proc.user_name -%}
  {%- set user_domain = active_proc.user_domain -%}
{%- else -%}
  {%- set proc = samples.processes | random -%}
  {%- set process_guid = '{' ~ module.rand.crypto.uuid4() ~ '}' -%}
  {%- set process_id = module.rand.number.integer(100, 65535) -%}
  {%- set process_image = proc.path -%}
  {%- set process_name = proc.name -%}
  {%- set user_name = (samples.usernames | random).username -%}
  {%- set user_domain = domain -%}
{%- endif -%}
{#- Pick a SetValue registry path from samples -#}
{%- set set_value_paths = [] -%}
{%- for rp in samples.registry_paths -%}
  {%- if rp.event_type == "SetValue" -%}
    {%- do set_value_paths.append(rp) -%}
  {%- endif -%}
{%- endfor -%}
{%- set reg = set_value_paths | random -%}
{#- Substitute SID and GUID placeholders -#}
{%- set target_object = reg.path | replace("{SID}", domain_sid ~ "-" ~ module.rand.number.integer(1100, 9999)) | replace("{GUID}", module.rand.crypto.uuid4()) | replace("{USER}", user_name) -%}
{%- set details = reg.details -%}
{#- Parse registry path into components -#}
{%- set reg_parts = target_object.split("\\") -%}
{%- set reg_hive = reg_parts[0] -%}
{%- set reg_key = "\\".join(reg_parts[1:]) -%}
{%- set reg_value = reg_parts[-1] -%}
{#- Determine registry data type -#}
{%- if details and details.startswith("DWORD") -%}
  {%- set reg_data_type = "SZ_DWORD" -%}
  {%- set reg_data_strings = [details.split("(")[1].split(")")[0]] -%}
{%- elif details and details.startswith("QWORD") -%}
  {%- set reg_data_type = "SZ_QWORD" -%}
  {%- set reg_data_strings = [details.split("(")[1].split(")")[0]] -%}
{%- elif details == "Binary Data" -%}
  {%- set reg_data_type = "REG_BINARY" -%}
  {%- set reg_data_strings = [] -%}
{%- else -%}
  {%- set reg_data_type = "REG_SZ" -%}
  {%- set reg_data_strings = [details] if details else [] -%}
{%- endif -%}
{%- set sysmon_pid = module.rand.number.integer(1000, 5000) -%}
{%- set sysmon_tid = module.rand.number.integer(1000, 8000) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "winlogbeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "RegistryEvent (Value Set)",
        "category": ["configuration", "registry"],
        "code": "13",
        "created": "{{ timestamp.isoformat() }}",
        "kind": "event",
        "module": "sysmon",
        "provider": "Microsoft-Windows-Sysmon",
        "type": ["change"]
    },
    "host": {
        "name": "{{ hostname }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "log": {
        "level": "information"
    },
    "process": {
        "entity_id": "{{ process_guid }}",
        "executable": {{ process_image | tojson }},
        "name": "{{ process_name }}",
        "pid": {{ process_id }}
    },
    "registry": {
        "data": {
{% if reg_data_strings | length > 0 %}
            "strings": {{ reg_data_strings | tojson }},
{% endif %}
            "type": "{{ reg_data_type }}"
        },
        "hive": "{{ reg_hive }}",
        "key": {{ reg_key | tojson }},
        "path": {{ target_object | tojson }},
        "value": "{{ reg_value }}"
    },
    "related": {
        "user": ["{{ user_name }}"]
    },
    "user": {
        "domain": "{{ user_domain }}",
        "id": "S-1-5-18",
        "name": "{{ user_name }}"
    },
    "winlog": {
        "channel": "Microsoft-Windows-Sysmon/Operational",
        "computer_name": "{{ fqdn }}",
        "event_data": {
            "Details": {{ details | tojson }},
            "EventType": "SetValue"
        },
        "event_id": "13",
        "opcode": "Info",
        "process": {
            "pid": {{ sysmon_pid }},
            "thread": {
                "id": {{ sysmon_tid }}
            }
        },
        "provider_guid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}",
        "provider_name": "Microsoft-Windows-Sysmon",
        "record_id": "{{ record_id }}",
        "user": {
            "identifier": "S-1-5-18"
        },
        "version": 2
    }
}
{%- do shared.set('record_id', (record_id + 1) % 2147483647) -%}