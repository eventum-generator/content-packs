{%- set host = samples.hosts | random -%}
{%- set hostname = host.name -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{%- set record_id = shared.get('record_id:' ~ hostname, 1) -%}
{#- Pick a driver from samples -#}
{%- set drv = samples.drivers | random -%}
{%- set hashes = "SHA1=" ~ drv.sha1 ~ ",MD5=" ~ drv.md5 ~ ",SHA256=" ~ drv.sha256 ~ ",IMPHASH=" ~ drv.imphash -%}
{#- Derive file name from path -#}
{%- set drv_parts = drv.image.split("\\") -%}
{%- set drv_name = drv_parts[-1] -%}
{%- set drv_directory = "\\".join(drv_parts[:-1]) -%}
{%- set sysmon_pid = module.rand.number.integer(1000, 5000) -%}
{%- set sysmon_tid = module.rand.number.integer(1000, 8000) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ host.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "winlogbeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "Driver loaded",
        "category": ["driver"],
        "code": "6",
        "created": "{{ timestamp.isoformat() }}",
        "kind": "event",
        "module": "sysmon",
        "provider": "Microsoft-Windows-Sysmon",
        "type": ["start"]
    },
    "file": {
        "code_signature": {
            "status": "{{ drv.signature_status }}",
            "subject_name": "{{ drv.signature }}",
            "trusted": {{ drv.signed }},
            "valid": {{ (drv.signature_status == "Valid") | tojson }}
        },
        "directory": {{ drv_directory | tojson }},
        "extension": "sys",
        "hash": {
            "md5": "{{ drv.md5 }}",
            "sha1": "{{ drv.sha1 }}",
            "sha256": "{{ drv.sha256 }}"
        },
        "name": "{{ drv_name }}",
        "path": {{ drv.image | tojson }},
        "pe": {
            "imphash": "{{ drv.imphash }}"
        }
    },
    "host": {
        "name": "{{ hostname }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "log": {
        "level": "information"
    },
    "related": {
        "hash": ["{{ drv.sha1 }}", "{{ drv.md5 }}", "{{ drv.sha256 }}", "{{ drv.imphash }}"]
    },
    "winlog": {
        "channel": "Microsoft-Windows-Sysmon/Operational",
        "computer_name": "{{ fqdn }}",
        "event_data": {
            "Signature": "{{ drv.signature }}",
            "SignatureStatus": "{{ drv.signature_status }}",
            "Signed": "{{ drv.signed }}"
        },
        "event_id": "6",
        "opcode": "Info",
        "process": {
            "pid": {{ sysmon_pid }},
            "thread": {
                "id": {{ sysmon_tid }}
            }
        },
        "provider_guid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}",
        "provider_name": "Microsoft-Windows-Sysmon",
        "record_id": "{{ record_id }}",
        "user": {
            "identifier": "S-1-5-18"
        },
        "version": 5
    }
}
{%- do shared.set('record_id:' ~ hostname, (record_id + 1) % 2147483647) -%}