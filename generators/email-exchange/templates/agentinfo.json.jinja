{#- AGENTINFO event â€” Transport agent logging (anti-spam verdicts, transport rules).
     Consumer template with rich anti-spam custom_data field. -#}
{%- set seq = shared.get('internal_message_id_seq', 34359738368) -%}
{%- set log_seq = shared.get('log_id_seq', 1000) -%}
{%- set fqdn = params.hostname ~ '.' ~ params.domain -%}

{#- Try to correlate with a message from the pool -#}
{%- set pool = shared.get('message_pool', []) -%}
{%- if pool | length > 0 -%}
  {%- set msg = pool | random -%}
  {%- set msg_id = msg.message_id -%}
  {%- set network_msg_id = msg.network_message_id -%}
  {%- set sender_email = msg.sender_email -%}
  {%- set sender_name = msg.sender_name -%}
  {%- set sender_domain = msg.sender_domain -%}
  {%- set recipient_email = msg.recipient_email -%}
  {%- set recipient_name = msg.recipient_name -%}
  {%- set subject = msg.subject -%}
  {%- set total_bytes = msg.total_bytes -%}
  {%- set directionality = msg.directionality -%}
  {%- set recipient_count = msg.recipient_count -%}
  {%- set client_ip = msg.get('client_ip', params.server_ip) -%}
{%- else -%}
  {%- set ext = samples.external_domains.weighted_pick('weight') -%}
  {%- set sender_user = module.faker.locale.en_US.user_name() -%}
  {%- set sender_email = sender_user ~ '@' ~ ext.domain -%}
  {%- set sender_name = sender_user -%}
  {%- set sender_domain = ext.domain -%}
  {%- set rcpt = samples.internal_users.pick() -%}
  {%- set recipient_email = rcpt.username ~ '@' ~ params.domain -%}
  {%- set recipient_name = rcpt.username -%}
  {%- set msg_id = '<' ~ (module.rand.crypto.uuid4() | replace("-", "")) ~ '@' ~ ext.mx_host ~ '>' -%}
  {%- set network_msg_id = module.rand.crypto.uuid4() -%}
  {%- set total_bytes = module.rand.number.clamp(module.rand.number.lognormal(10.2, 1.4) | int, 800, 25000000) -%}
  {%- set subject_cat = module.rand.weighted_choice(["business", "automated", "newsletter"], [50, 40, 10]) -%}
  {%- set subject = (samples.subjects | selectattr("category", "equalto", subject_cat) | list | random).text -%}
  {%- set directionality = "Incoming" -%}
  {%- set recipient_count = 1 -%}
  {%- set client_ip = ext.ip -%}
{%- endif -%}

{%- set log_id = module.rand.crypto.uuid4() -%}
{%- set email_direction = "inbound" if directionality == "Incoming" else "internal" -%}

{#- Anti-spam verdict fields (X-Forefront-Antispam-Report) -#}
{%- set scl = module.rand.weighted_choice(["-1", "0", "1", "2", "5", "6", "9"], [5, 60, 15, 10, 4, 3, 3]) -%}
{%- set sfv = module.rand.weighted_choice(
    ["NSPM", "SKN", "SFE", "SKA", "SPM", "SKS", "BLK"],
    [60, 10, 8, 7, 8, 4, 3]
) -%}
{%- set ipv = module.rand.weighted_choice(["NLI", "CAL"], [90, 10]) -%}
{%- set country = module.rand.weighted_choice(
    ["US", "DE", "GB", "CA", "JP", "CN", "RU", "BR", "IN", "FR"],
    [35, 10, 8, 7, 5, 8, 7, 5, 5, 10]
) -%}
{%- set bcl = module.rand.weighted_choice(["0", "1", "3", "5", "7"], [60, 15, 12, 8, 5]) -%}

{#- Build anti-spam custom_data -#}
{%- set antispam_data = 'S:SFA=SUM|SFV=' ~ sfv ~ '|IPV=' ~ ipv ~ '|SCL=' ~ scl ~ '|CTRY=' ~ country ~ '|H=' ~ client_ip ~ '|BCL=' ~ bcl -%}
{%- set custom_data = 'S:DeliveryPriority=Normal;S:AccountForest=' ~ params.domain ~ ';' ~ antispam_data -%}

{#- Agent name -#}
{%- set agent_name = module.rand.weighted_choice(
    ["Transport Rule Agent", "Content Filter Agent", "Sender Filter Agent", "Recipient Filter Agent", "Sender ID Agent"],
    [30, 30, 15, 15, 10]
) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "domain": "{{ params.domain }}",
        "ip": "{{ params.server_ip }}",
        "user": {
            "email": "{{ recipient_email }}",
            "name": "{{ recipient_name }}"
        }
    },
    "ecs": {
        "version": "{{ params.ecs_version }}"
    },
    "email": {
        "direction": "{{ email_direction }}",
        "delivery_timestamp": "{{ timestamp.isoformat() }}",
        "from": {
            "address": ["{{ sender_email }}"]
        },
        "local_id": "{{ network_msg_id }}",
        "message_id": "{{ msg_id }}",
        "subject": "{{ subject }}",
        "to": {
            "address": ["{{ recipient_email }}"]
        },
        "attachments": {
            "file": {
                "size": {{ total_bytes }}
            }
        }
    },
    "event": {
        "action": "agentinfo",
        "category": ["email"],
        "dataset": "microsoft_exchange.messagetracking",
        "kind": "event",
        "module": "microsoft_exchange",
        "outcome": "success",
        "type": ["info"]
    },
    "microsoft_exchange": {
        "messagetracking": {
            "client_ip": "{{ client_ip }}",
            "client_hostname": "",
            "server_ip": "{{ params.server_ip }}",
            "server_hostname": "{{ fqdn }}",
            "source_context": "{{ agent_name }}",
            "connector_id": "",
            "source": "AGENT",
            "event_id": "AGENTINFO",
            "internal_message_id": {{ seq }},
            "network_message_id": "{{ network_msg_id }}",
            "recipient_status": "",
            "recipient_count": {{ recipient_count }},
            "related_recipient_address": "",
            "reference": "",
            "return_path": "{{ sender_email }}",
            "message_info": "",
            "directionality": "{{ directionality }}",
            "original_client_ip": "{{ client_ip }}",
            "original_server_ip": "{{ params.server_ip }}",
            "custom_data": "{{ custom_data }}",
            "transport_traffic_type": "Email",
            "log_id": "{{ log_id }}",
            "schema_version": "{{ params.schema_version }}"
        }
    },
    "observer": {
        "hostname": "{{ fqdn }}",
        "ip": ["{{ params.server_ip }}"],
        "product": "Exchange Server",
        "type": "mail",
        "vendor": "Microsoft",
        "version": "{{ params.schema_version }}"
    },
    "related": {
        "ip": ["{{ client_ip }}", "{{ params.server_ip }}"],
        "user": ["{{ sender_name }}", "{{ recipient_name }}"]
    },
    "source": {
        "domain": "{{ sender_domain }}",
        "ip": "{{ client_ip }}",
        "user": {
            "email": "{{ sender_email }}",
            "name": "{{ sender_name }}"
        }
    },
    "tags": ["microsoft-exchange", "forwarded"]
}
{%- do shared.set('internal_message_id_seq', (seq + 1) % 2147483647) -%}
{%- do shared.set('log_id_seq', (log_seq + 1) % 2147483647) -%}
