{#- DSN event â€” Delivery Status Notification (bounce/NDR) generated. -#}
{%- set seq = shared.get('internal_message_id_seq', 34359738368) -%}
{%- set log_seq = shared.get('log_id_seq', 1000) -%}
{%- set fqdn = params.hostname ~ '.' ~ params.domain -%}

{#- DSN is sent back to the original sender after a delivery failure -#}
{%- set original_sender = samples.internal_users.pick() -%}
{%- set original_sender_email = original_sender.username ~ '@' ~ params.domain -%}

{#- The failed recipient -#}
{%- set ext = samples.external_domains.weighted_pick('weight') -%}
{%- set failed_recipient = module.faker.locale.en_US.user_name() ~ '@' ~ ext.domain -%}

{#- DSN message-id references the original message -#}
{%- set original_msg_id = '<' ~ (module.rand.crypto.uuid4() | replace("-", "")) ~ '@' ~ fqdn ~ '>' -%}
{%- set dsn_msg_id = '<' ~ (module.rand.crypto.uuid4() | replace("-", "")) ~ '@' ~ fqdn ~ '>' -%}
{%- set network_msg_id = module.rand.crypto.uuid4() -%}
{%- set log_id = module.rand.crypto.uuid4() -%}

{#- DSN messages are small -#}
{%- set total_bytes = module.rand.number.integer(2000, 8000) -%}

{#- DSN type -#}
{%- set dsn_type = module.rand.weighted_choice(
    ["5.1.1 (mailbox not found)", "5.2.1 (mailbox full)", "5.4.4 (unable to route)",
     "5.7.1 (delivery not authorized)", "4.4.7 (message expired)"],
    [35, 25, 15, 15, 10]
) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "domain": "{{ params.domain }}",
        "ip": "{{ params.server_ip }}",
        "user": {
            "email": "{{ original_sender_email }}",
            "name": "{{ original_sender.username }}"
        }
    },
    "ecs": {
        "version": "{{ params.ecs_version }}"
    },
    "email": {
        "direction": "internal",
        "delivery_timestamp": "{{ timestamp.isoformat() }}",
        "from": {
            "address": ["<>"]
        },
        "local_id": "{{ network_msg_id }}",
        "message_id": "{{ dsn_msg_id }}",
        "subject": "Undeliverable: {{ dsn_type }}",
        "to": {
            "address": ["{{ original_sender_email }}"]
        },
        "attachments": {
            "file": {
                "size": {{ total_bytes }}
            }
        }
    },
    "event": {
        "action": "dsn",
        "category": ["email"],
        "dataset": "microsoft_exchange.messagetracking",
        "kind": "event",
        "module": "microsoft_exchange",
        "outcome": "success",
        "type": ["info"]
    },
    "microsoft_exchange": {
        "messagetracking": {
            "client_ip": "{{ params.server_ip }}",
            "client_hostname": "{{ fqdn }}",
            "server_ip": "{{ params.server_ip }}",
            "server_hostname": "{{ fqdn }}",
            "source_context": "DSN {{ dsn_type }}",
            "connector_id": "",
            "source": "DSN",
            "event_id": "DSN",
            "internal_message_id": {{ seq }},
            "network_message_id": "{{ network_msg_id }}",
            "recipient_status": "",
            "recipient_count": 1,
            "related_recipient_address": "{{ failed_recipient }}",
            "reference": "{{ original_msg_id }}",
            "return_path": "<>",
            "message_info": "",
            "directionality": "Originating",
            "original_client_ip": "{{ params.server_ip }}",
            "original_server_ip": "{{ params.server_ip }}",
            "custom_data": "{{ 'S:DeliveryPriority=Normal;S:AccountForest=' ~ params.domain }}",
            "transport_traffic_type": "Email",
            "log_id": "{{ log_id }}",
            "schema_version": "{{ params.schema_version }}"
        }
    },
    "observer": {
        "hostname": "{{ fqdn }}",
        "ip": ["{{ params.server_ip }}"],
        "product": "Exchange Server",
        "type": "mail",
        "vendor": "Microsoft",
        "version": "{{ params.schema_version }}"
    },
    "related": {
        "ip": ["{{ params.server_ip }}"],
        "user": ["{{ original_sender.username }}"]
    },
    "source": {
        "domain": "{{ params.domain }}",
        "ip": "{{ params.server_ip }}",
        "user": {
            "email": "",
            "name": ""
        }
    },
    "tags": ["microsoft-exchange", "forwarded"]
}
{%- do shared.set('internal_message_id_seq', (seq + 1) % 2147483647) -%}
{%- do shared.set('log_id_seq', (log_seq + 1) % 2147483647) -%}
