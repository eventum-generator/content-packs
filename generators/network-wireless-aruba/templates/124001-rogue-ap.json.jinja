{%- set controller = params.controller_hostname -%}
{%- set controller_ip = params.controller_ip -%}

{#- Detecting AP (one of ours) -#}
{%- set detecting_ap = samples.access_points | random -%}

{#- Rogue AP attributes -#}
{%- set rogue_bssid = module.rand.network.mac() -%}
{%- set rogue_ssid = module.rand.weighted_choice(
  ["NETGEAR-5G", "linksys", "xfinitywifi", "HP-Print-" ~ module.rand.string.hex(4), "FreeWiFi", "default", "HOME-" ~ module.rand.string.hex(4), "TP-Link_" ~ module.rand.string.hex(4)],
  [15, 10, 15, 10, 15, 10, 15, 10]
) -%}
{%- set confidence = module.rand.number.integer(60, 99) -%}

{#- Classification -#}
{%- set classification = module.rand.weighted_choice(
  ["Suspected Rogue", "Known Interferer", "Neighbor", "DoS Attack"],
  [50, 25, 20, 5]
) -%}

{#- Syslog message -#}
{%- set msg = "AM " ~ detecting_ap.mac ~ ": Rogue AP detected with SSID " ~ rogue_ssid ~ " and BSSID " ~ rogue_bssid ~ ", Conf-Level " ~ confidence ~ ", Classification " ~ classification -%}
{%- set pri = 164 -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ controller }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "aruba": {
    "wireless": {
      "classification": "{{ classification }}",
      "confidence_level": {{ confidence }},
      "detecting_ap_mac": "{{ detecting_ap.mac }}",
      "detecting_ap_name": "{{ detecting_ap.name }}",
      "message_id": "124001",
      "process": "wms",
      "rogue_bssid": "{{ rogue_bssid }}",
      "rogue_ssid": "{{ rogue_ssid }}"
    }
  },
  "data_stream": {
    "dataset": "aruba.wireless",
    "namespace": "default",
    "type": "logs"
  },
  "ecs": {
    "version": "{{ params.ecs_version }}"
  },
  "event": {
    "action": "rogue-ap-detected",
    "category": ["intrusion_detection"],
    "code": "124001",
    "dataset": "aruba.wireless",
    "kind": "alert",
    "module": "aruba",
    "original": "<{{ pri }}>{{ timestamp.strftime('%b %d %H:%M:%S %Y') }} {{ controller }} wms[1847]: <124001> <WARN> <{{ controller }} {{ controller_ip }}> {{ msg }}",
    "outcome": "success",
    "severity": 4,
    "type": ["info"]
  },
  "host": {
    "hostname": "{{ controller }}"
  },
  "log": {
    "level": "warning",
    "syslog": {
      "facility": {
        "code": 20,
        "name": "local4"
      },
      "priority": {{ pri }},
      "severity": {
        "code": 4,
        "name": "Warning"
      }
    }
  },
  "observer": {
    "hostname": "{{ controller }}",
    "ip": ["{{ controller_ip }}"],
    "name": "{{ controller }}",
    "product": "ArubaOS",
    "type": "wireless",
    "vendor": "Aruba"
  },
  "related": {
    "hosts": ["{{ controller }}", "{{ detecting_ap.name }}"]
  },
  "tags": ["aruba-wireless", "forwarded"]
}