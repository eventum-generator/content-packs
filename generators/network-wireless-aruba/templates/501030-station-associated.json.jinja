{%- set controller = params.controller_hostname -%}
{%- set controller_ip = params.controller_ip -%}

{#- Pick AP, SSID, and generate client identity -#}
{%- set ap = samples.access_points | random -%}
{%- set ssid = samples.ssids.weighted_pick('weight') -%}
{%- set user = (samples.usernames | random) -%}
{%- set client_mac = module.rand.network.mac() -%}
{%- set client_ip = ssid.network ~ "." ~ module.rand.number.integer(1, 254) ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set bssid = ap.mac -%}

{#- Push to active_clients pool -#}
{%- set pool = shared.get('active_clients', []) -%}
{%- do pool.append({
  "mac": client_mac,
  "ip": client_ip,
  "username": user.username,
  "ap_name": ap.name,
  "ap_ip": ap.ip,
  "bssid": bssid,
  "ssid": ssid.name,
  "vlan_id": ssid.vlan_id,
  "role": ssid.role,
  "network": ssid.network,
  "auth_method": ssid.auth_method,
  "aaa_profile": ssid.aaa_profile
}) -%}
{%- set pool_cap = params.client_pool_size | int -%}
{%- if pool | length > pool_cap -%}
  {%- do pool.pop(0) -%}
{%- endif -%}
{%- do shared.set('active_clients', pool) -%}

{#- Syslog message -#}
{%- set msg = "Station mac:" ~ client_mac ~ " associated to AP " ~ ap.name ~ " BSSID " ~ bssid ~ " SSID " ~ ssid.name -%}
{%- set pri = 165 -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ controller }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "aruba": {
    "wireless": {
      "ap_name": "{{ ap.name }}",
      "bssid": "{{ bssid }}",
      "client_mac": "{{ client_mac }}",
      "message_id": "501030",
      "process": "stm",
      "ssid": "{{ ssid.name }}"
    }
  },
  "data_stream": {
    "dataset": "aruba.wireless",
    "namespace": "default",
    "type": "logs"
  },
  "ecs": {
    "version": "{{ params.ecs_version }}"
  },
  "event": {
    "action": "station-associated",
    "category": ["session", "network"],
    "code": "501030",
    "dataset": "aruba.wireless",
    "kind": "event",
    "module": "aruba",
    "original": "<{{ pri }}>{{ timestamp.strftime('%b %d %H:%M:%S %Y') }} {{ controller }} stm[2367]: <501030> <NOTI> <{{ controller }} {{ controller_ip }}> {{ msg }}",
    "outcome": "success",
    "severity": 5,
    "type": ["start", "connection"]
  },
  "host": {
    "hostname": "{{ controller }}"
  },
  "log": {
    "level": "notice",
    "syslog": {
      "facility": {
        "code": 20,
        "name": "local4"
      },
      "priority": {{ pri }},
      "severity": {
        "code": 5,
        "name": "Notice"
      }
    }
  },
  "observer": {
    "hostname": "{{ controller }}",
    "ip": ["{{ controller_ip }}"],
    "name": "{{ controller }}",
    "product": "ArubaOS",
    "type": "wireless",
    "vendor": "Aruba"
  },
  "related": {
    "hosts": ["{{ controller }}", "{{ ap.name }}"],
    "ip": ["{{ client_ip }}", "{{ controller_ip }}"]
  },
  "source": {
    "ip": "{{ client_ip }}",
    "mac": "{{ client_mac }}"
  },
  "tags": ["aruba-wireless", "forwarded"]
}