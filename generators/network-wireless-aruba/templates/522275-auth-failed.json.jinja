{%- set controller = params.controller_hostname -%}
{%- set controller_ip = params.controller_ip -%}

{#- RADIUS server -#}
{%- set radius = module.rand.weighted_choice(
  [{"ip": "10.1.1.100", "name": "RADIUS-Primary"}, {"ip": "10.1.1.101", "name": "RADIUS-Secondary"}],
  [80, 20]
) -%}

{#- Generate failed auth client (not from pool â€” failed clients don't join) -#}
{%- set ssid = samples.ssids.weighted_pick('weight') -%}
{%- set ap = samples.access_points | random -%}
{%- set client_mac = module.rand.network.mac() -%}
{%- set bssid = ap.mac -%}

{#- Username: mix of real users (typo/expired) and unknown -#}
{%- if module.rand.chance(0.6) -%}
  {%- set username = (samples.usernames | random).username -%}
{%- else -%}
  {%- set username = module.rand.choice(["unknown", "admin", "test", "guest", "temp_user"]) -%}
{%- endif -%}

{#- Failure reason -#}
{%- set reason = module.rand.weighted_choice(
  ["Authentication rejected", "RADIUS timeout", "Invalid credentials", "Certificate validation failed", "Account disabled"],
  [35, 20, 25, 12, 8]
) -%}

{#- Syslog message -#}
{%- set msg = "User Authentication failed. username=" ~ username ~ " userip=0.0.0.0 usermac=" ~ client_mac ~ " authmethod=" ~ ssid.auth_method ~ " servername=" ~ radius.name ~ " serverip=" ~ radius.ip ~ " apname=" ~ ap.name ~ " bssid=" ~ bssid -%}
{%- set pri = 164 -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ controller }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "aruba": {
    "wireless": {
      "ap_name": "{{ ap.name }}",
      "auth_method": "{{ ssid.auth_method }}",
      "auth_server": "{{ radius.name }}",
      "bssid": "{{ bssid }}",
      "client_mac": "{{ client_mac }}",
      "message_id": "522275",
      "process": "authmgr",
      "reason": "{{ reason }}",
      "ssid": "{{ ssid.name }}"
    }
  },
  "data_stream": {
    "dataset": "aruba.wireless",
    "namespace": "default",
    "type": "logs"
  },
  "destination": {
    "address": "{{ radius.ip }}",
    "ip": "{{ radius.ip }}"
  },
  "ecs": {
    "version": "{{ params.ecs_version }}"
  },
  "event": {
    "action": "user-authentication-failed",
    "category": ["authentication"],
    "code": "522275",
    "dataset": "aruba.wireless",
    "kind": "event",
    "module": "aruba",
    "original": "<{{ pri }}>{{ timestamp.strftime('%b %d %H:%M:%S %Y') }} {{ controller }} authmgr[3469]: <522275> <WARN> <{{ controller }} {{ controller_ip }}> {{ msg }}",
    "outcome": "failure",
    "reason": "{{ reason }}",
    "severity": 4,
    "type": ["start"]
  },
  "host": {
    "hostname": "{{ controller }}"
  },
  "log": {
    "level": "warning",
    "syslog": {
      "facility": {
        "code": 20,
        "name": "local4"
      },
      "priority": {{ pri }},
      "severity": {
        "code": 4,
        "name": "Warning"
      }
    }
  },
  "observer": {
    "hostname": "{{ controller }}",
    "ip": ["{{ controller_ip }}"],
    "name": "{{ controller }}",
    "product": "ArubaOS",
    "type": "wireless",
    "vendor": "Aruba"
  },
  "related": {
    "hosts": ["{{ controller }}", "{{ ap.name }}"],
    "ip": ["{{ radius.ip }}", "{{ controller_ip }}"],
    "user": ["{{ username }}"]
  },
  "source": {
    "mac": "{{ client_mac }}",
    "user": {
      "name": "{{ username }}"
    }
  },
  "tags": ["aruba-wireless", "forwarded"],
  "user": {
    "name": "{{ username }}"
  }
}