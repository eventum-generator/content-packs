{%- set controller = params.controller_hostname -%}
{%- set controller_ip = params.controller_ip -%}

{#- Pick an AP -#}
{%- set ap = samples.access_points | random -%}

{#- Radio band selection -#}
{%- set radio = module.rand.weighted_choice(["5GHz", "2.4GHz"], [70, 30]) -%}

{#- Channel lists per band -#}
{%- if radio == "2.4GHz" -%}
  {%- set channels = [1, 6, 11] -%}
  {%- set old_channel = ap.radio_2g_channel | int -%}
{%- else -%}
  {%- set channels = [36, 40, 44, 48, 52, 56, 60, 64, 100, 104, 108, 112, 149, 153, 157, 161, 165] -%}
  {%- set old_channel = ap.radio_5g_channel | int -%}
{%- endif -%}

{#- Pick a new channel different from old -#}
{%- set available = [] -%}
{%- for ch in channels -%}
  {%- if ch != old_channel -%}
    {%- do available.append(ch) -%}
  {%- endif -%}
{%- endfor -%}
{%- set new_channel = module.rand.choice(available) -%}

{#- Change reason -#}
{%- set reason = module.rand.weighted_choice(
  ["Radar detected", "Interference", "Load balancing", "Noise floor changed", "Optimization"],
  [15, 30, 25, 15, 15]
) -%}

{#- Syslog message -#}
{%- set msg = "AP " ~ ap.name ~ ": ARM changed channel on radio " ~ radio ~ " from " ~ old_channel ~ " to " ~ new_channel ~ " (reason: " ~ reason ~ ")" -%}
{%- set pri = 165 -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "agent": {
    "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
    "id": "{{ params.agent_id }}",
    "name": "{{ controller }}",
    "type": "filebeat",
    "version": "{{ params.agent_version }}"
  },
  "aruba": {
    "wireless": {
      "ap_name": "{{ ap.name }}",
      "message_id": "500010",
      "new_channel": {{ new_channel }},
      "old_channel": {{ old_channel }},
      "process": "sapd",
      "radio": "{{ radio }}",
      "reason": "{{ reason }}"
    }
  },
  "data_stream": {
    "dataset": "aruba.wireless",
    "namespace": "default",
    "type": "logs"
  },
  "ecs": {
    "version": "{{ params.ecs_version }}"
  },
  "event": {
    "action": "channel-change",
    "category": ["network"],
    "code": "500010",
    "dataset": "aruba.wireless",
    "kind": "event",
    "module": "aruba",
    "original": "<{{ pri }}>{{ timestamp.strftime('%b %d %H:%M:%S %Y') }} {{ controller }} sapd[1548]: <500010> <NOTI> <{{ controller }} {{ controller_ip }}> {{ msg }}",
    "outcome": "success",
    "reason": "{{ reason }}",
    "severity": 5,
    "type": ["info"]
  },
  "host": {
    "hostname": "{{ controller }}"
  },
  "log": {
    "level": "notice",
    "syslog": {
      "facility": {
        "code": 20,
        "name": "local4"
      },
      "priority": {{ pri }},
      "severity": {
        "code": 5,
        "name": "Notice"
      }
    }
  },
  "observer": {
    "hostname": "{{ controller }}",
    "ip": ["{{ controller_ip }}"],
    "name": "{{ controller }}",
    "product": "ArubaOS",
    "type": "wireless",
    "vendor": "Aruba"
  },
  "related": {
    "hosts": ["{{ controller }}", "{{ ap.name }}"],
    "ip": ["{{ controller_ip }}"]
  },
  "tags": ["aruba-wireless", "forwarded"]
}