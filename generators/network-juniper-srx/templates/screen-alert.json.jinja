{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- RT_SCREEN (RT_IDS) â€” screen/DoS protection alerts -#}
{#- Define screen event types with their metadata -#}
{%- set screen_types = [
  {"attack_name": "TCP port scan!", "tag": "RT_SCREEN_TCP", "event_action": "scan_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "SYN flood!", "tag": "RT_SCREEN_TCP", "event_action": "flood_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "No TCP flag!", "tag": "RT_SCREEN_TCP", "event_action": "illegal_tcp_flag_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "SYN and FIN bits!", "tag": "RT_SCREEN_TCP", "event_action": "illegal_tcp_flag_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "Land attack!", "tag": "RT_SCREEN_TCP", "event_action": "attack_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "WinNuke attack!", "tag": "RT_SCREEN_TCP", "event_action": "attack_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "ICMP flood!", "tag": "RT_SCREEN_ICMP", "event_action": "flood_detected", "transport": "icmp", "protocol_id": "1"},
  {"attack_name": "Large ICMP packet!", "tag": "RT_SCREEN_ICMP", "event_action": "fragment_detected", "transport": "icmp", "protocol_id": "1"},
  {"attack_name": "UDP flood!", "tag": "RT_SCREEN_UDP", "event_action": "flood_detected", "transport": "udp", "protocol_id": "17"},
  {"attack_name": "IP spoofing!", "tag": "RT_SCREEN_IP", "event_action": "spoofing_detected", "transport": "tcp", "protocol_id": "6"},
  {"attack_name": "IP address sweep!", "tag": "RT_SCREEN_IP", "event_action": "sweep_detected", "transport": "tcp", "protocol_id": "6"}
] -%}
{%- set screen_weights = [15, 20, 8, 6, 3, 2, 12, 5, 12, 8, 9] -%}
{%- set screen = module.rand.weighted_choice(screen_types, screen_weights) -%}
{#- Screen events are almost always from external sources -#}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{%- set src_port = module.rand.number.integer(1024, 65535) -%}
{%- set dst_host = samples.internal_hosts | random -%}
{%- set dst_ip = dst_host.ip -%}
{%- set dst_port = module.rand.weighted_choice([443, 80, 22, 3389, 445, 53, 8080, 1433], [20, 15, 15, 10, 10, 10, 10, 10]) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "{{ screen.event_action }}",
        "category": ["network", "intrusion_detection"],
        "dataset": "juniper_srx.log",
        "kind": "alert",
        "module": "juniper_srx",
        "outcome": "success",
        "severity": 11,
        "type": ["info", "denied", "connection"]
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "juniper": {
        "srx": {
            "action": "drop",
            "attack_name": "{{ screen.attack_name }}",
            "process": "RT_IDS",
            "tag": "{{ screen.tag }}"
        }
    },
    "log": {
        "level": "error"
    },
    "network": {
        "iana_number": "{{ screen.protocol_id }}",
        "transport": "{{ screen.transport }}"
    },
    "observer": {
        "ingress": {
            "interface": {
                "name": "ge-0/0/0.0"
            },
            "zone": "untrust"
        },
        "name": "{{ fqdn }}",
        "product": "SRX",
        "type": "firewall",
        "vendor": "Juniper"
    },
    "process": {
        "name": "RT_IDS"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "tags": ["juniper-srx", "forwarded"]
}