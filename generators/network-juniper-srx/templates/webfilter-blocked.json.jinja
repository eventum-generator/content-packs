{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- WEBFILTER_URL_BLOCKED â€” URL blocked by Enhanced Web Filtering -#}
{#- Pick a blocked destination -#}
{%- set blocked_dests = [] -%}
{%- set blocked_weights = [] -%}
{%- for dest in samples.web_destinations -%}
  {%- if dest.action == "block" -%}
    {%- do blocked_dests.append(dest) -%}
    {%- do blocked_weights.append(dest.weight) -%}
  {%- endif -%}
{%- endfor -%}
{%- set dest = module.rand.weighted_choice(blocked_dests, blocked_weights) -%}
{#- Source is always internal -#}
{%- set src_host = samples.internal_hosts | selectattr("subnet", "equalto", "workstations") | list | random -%}
{%- set src_ip = src_host.ip -%}
{%- set src_port = module.rand.number.integer(49152, 65535) -%}
{%- set dst_ip = module.rand.network.ip_v4_public() -%}
{%- set dst_port = module.rand.weighted_choice([443, 80], [85, 15]) -%}
{%- set protocol_id = "6" -%}
{#- Reason varies: mostly predefined category, sometimes blacklist -#}
{%- set reason = module.rand.weighted_choice(["BY_PRE_DEFINED", "BY_BLACK_LIST", "BY_CUSTOM_CATEGORY"], [75, 15, 10]) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "web_filter",
        "category": ["network", "malware"],
        "dataset": "juniper_srx.log",
        "kind": "alert",
        "module": "juniper_srx",
        "outcome": "success",
        "severity": 12,
        "type": ["info", "denied", "connection"]
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "juniper": {
        "srx": {
            "category": "{{ dest.category }}",
            "process": "RT_UTM",
            "profile": "{{ params.get('wf_profile', 'corporate-web-filter') }}",
            "reason": "{{ reason }}",
            "roles": "N/A",
            "tag": "WEBFILTER_URL_BLOCKED",
            "username": "N/A"
        }
    },
    "log": {
        "level": "warning"
    },
    "network": {
        "iana_number": "{{ protocol_id }}",
        "transport": "tcp"
    },
    "observer": {
        "egress": {
            "zone": "untrust"
        },
        "ingress": {
            "interface": {
                "name": "ge-0/0/1.0"
            },
            "zone": "trust"
        },
        "name": "{{ fqdn }}",
        "product": "SRX",
        "type": "firewall",
        "vendor": "Juniper"
    },
    "process": {
        "name": "RT_UTM"
    },
    "related": {
        "hosts": ["{{ dest.domain }}"],
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "tags": ["juniper-srx", "forwarded"],
    "url": {
        "domain": "{{ dest.domain }}",
        "path": "{{ dest.path }}"
    }
}