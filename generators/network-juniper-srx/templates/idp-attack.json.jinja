{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- IDP_ATTACK_LOG_EVENT â€” intrusion detection/prevention alert -#}
{#- Pick a signature with weighted distribution -#}
{%- set sig = samples.idp_signatures.weighted_pick('weight') -%}
{#- Attacks are predominantly inbound -#}
{%- set direction_type = module.rand.weighted_choice(["inbound", "outbound"], [85, 15]) -%}
{#- Targeted service port based on attack signature -#}
{%- set attack_services = {
  "HTTP": {"port": 80, "protocol_id": "6", "transport": "tcp"},
  "SSL": {"port": 443, "protocol_id": "6", "transport": "tcp"},
  "SSH": {"port": 22, "protocol_id": "6", "transport": "tcp"},
  "FTP": {"port": 21, "protocol_id": "6", "transport": "tcp"},
  "DNS": {"port": 53, "protocol_id": "17", "transport": "udp"},
  "SMB": {"port": 445, "protocol_id": "6", "transport": "tcp"},
  "TCP": {"port": module.rand.number.integer(1024, 65535), "protocol_id": "6", "transport": "tcp"}
} -%}
{%- set svc = attack_services.get(sig.service, attack_services.TCP) -%}
{#- Generate IPs -#}
{%- if direction_type == "inbound" -%}
  {%- set src_ip = module.rand.network.ip_v4_public() -%}
  {%- set src_port = module.rand.number.integer(1024, 65535) -%}
  {%- set dst_host = samples.internal_hosts | random -%}
  {%- set dst_ip = dst_host.ip -%}
  {%- set dst_port = svc.port -%}
  {%- set ingress_zone = "untrust" -%}
  {%- set egress_zone = "trust" -%}
  {%- set ingress_iface = "ge-0/0/0.0" -%}
  {%- set egress_iface = "ge-0/0/1.0" -%}
{%- else -%}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set src_ip = src_host.ip -%}
  {%- set src_port = module.rand.number.integer(49152, 65535) -%}
  {%- set dst_ip = module.rand.network.ip_v4_public() -%}
  {%- set dst_port = svc.port -%}
  {%- set ingress_zone = "trust" -%}
  {%- set egress_zone = "untrust" -%}
  {%- set ingress_iface = "ge-0/0/1.0" -%}
  {%- set egress_iface = "ge-0/0/0.0" -%}
{%- endif -%}
{#- Map severity to log level -#}
{%- set severity_to_level = {"CRITICAL": "critical", "HIGH": "error", "MEDIUM": "warning", "LOW": "informational"} -%}
{%- set log_level = severity_to_level.get(sig.severity, "warning") -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "security_threat",
        "category": ["network", "intrusion_detection"],
        "dataset": "juniper_srx.log",
        "kind": "alert",
        "module": "juniper_srx",
        "outcome": "success",
        "severity": 14,
        "type": ["info", "denied", "connection"]
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "juniper": {
        "srx": {
            "action": "{{ sig.action }}",
            "alert": "no",
            "attack_name": "{{ sig.name }}",
            "epoch_time": "{{ timestamp.strftime('%s') }}",
            "message_type": "SIG",
            "packet_log_id": 0,
            "process": "RT_IDP",
            "repeat_count": 0,
            "service_name": "SERVICE_IDP",
            "tag": "IDP_ATTACK_LOG_EVENT",
            "threat_severity": "{{ sig.severity }}"
        }
    },
    "log": {
        "level": "{{ log_level }}"
    },
    "network": {
        "iana_number": "{{ svc.protocol_id }}",
        "transport": "{{ svc.transport }}"
    },
    "observer": {
        "egress": {
            "interface": {
                "name": "{{ egress_iface }}"
            },
            "zone": "{{ egress_zone }}"
        },
        "ingress": {
            "interface": {
                "name": "{{ ingress_iface }}"
            },
            "zone": "{{ ingress_zone }}"
        },
        "name": "{{ fqdn }}",
        "product": "SRX",
        "type": "firewall",
        "vendor": "Juniper"
    },
    "process": {
        "name": "RT_IDP"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "rule": {
        "id": "1",
        "name": "IPS"
    },
    "source": {
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "tags": ["juniper-srx", "forwarded"]
}