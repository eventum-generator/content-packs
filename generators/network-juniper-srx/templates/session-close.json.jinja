{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- RT_FLOW_SESSION_CLOSE â€” consume correlated session or generate standalone -#}
{%- set active_sessions = shared.get('active_sessions', []) -%}
{%- if active_sessions | length > 0 -%}
  {%- set session = active_sessions.pop(0) -%}
  {%- do shared.set('active_sessions', active_sessions) -%}
  {%- set src_ip = session.src_ip -%}
  {%- set src_port = session.src_port -%}
  {%- set dst_ip = session.dst_ip -%}
  {%- set dst_port = session.dst_port -%}
  {%- set protocol_id = session.protocol_id -%}
  {%- set transport = session.transport -%}
  {%- set application = session.application -%}
  {%- set service_name = session.service_name -%}
  {%- set policy_name = session.policy_name -%}
  {%- set ingress_zone = session.ingress_zone -%}
  {%- set egress_zone = session.egress_zone -%}
  {%- set ingress_iface = session.ingress_iface -%}
  {%- set session_id = session.session_id -%}
  {%- set has_nat = session.has_nat -%}
  {%- set nat_src_ip = session.nat_src_ip -%}
  {%- set nat_src_port = session.nat_src_port -%}
  {%- set nat_rule = session.nat_rule -%}
{%- else -%}
  {#- Fallback: generate standalone session-close -#}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set src_ip = src_host.ip -%}
  {%- set src_port = module.rand.number.integer(49152, 65535) -%}
  {%- set dst_ip = module.rand.network.ip_v4_public() -%}
  {%- set dst_port = module.rand.weighted_choice([443, 80, 53, 22, 8443], [40, 20, 15, 10, 15]) -%}
  {%- set protocol_id = "6" -%}
  {%- set transport = "tcp" -%}
  {%- set application = "SSL" -%}
  {%- set service_name = "junos-https" -%}
  {%- set policy_name = "allow-outbound-web" -%}
  {%- set ingress_zone = "trust" -%}
  {%- set egress_zone = "untrust" -%}
  {%- set ingress_iface = "ge-0/0/1.0" -%}
  {%- set session_id = module.rand.number.integer(100000, 9999999) -%}
  {%- set has_nat = false -%}
  {%- set nat_src_ip = src_ip -%}
  {%- set nat_src_port = src_port -%}
  {%- set nat_rule = "None" -%}
{%- endif -%}
{#- Close reason -#}
{%- set reason = module.rand.weighted_choice(["TCP FIN", "idle Timeout", "TCP RST", "response received", "aged out", "unset"], [50, 25, 13, 5, 5, 2]) -%}
{#- Session metrics -#}
{%- set elapsed_time = module.rand.number.integer(1, 3600) -%}
{%- set src_bytes = module.rand.number.integer(200, 1000000) -%}
{%- set dst_bytes = module.rand.number.integer(200, 5000000) -%}
{%- set src_packets = module.rand.number.integer(3, 2000) -%}
{%- set dst_packets = module.rand.number.integer(3, 5000) -%}
{#- Encrypted flag based on application -#}
{%- if application == "SSL" -%}
  {%- set encrypted = "Yes" -%}
{%- elif application in ["HTTP", "DNS", "FTP", "SMTP"] -%}
  {%- set encrypted = "No" -%}
{%- else -%}
  {%- set encrypted = "UNKNOWN" -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "bytes": {{ dst_bytes }},
        "ip": "{{ dst_ip }}",
{%- if has_nat %}
        "nat": {
            "ip": "{{ dst_ip }}",
            "port": {{ dst_port }}
        },
{%- endif %}
        "packets": {{ dst_packets }},
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "flow_close",
        "category": ["network"],
        "dataset": "juniper_srx.log",
        "duration": {{ elapsed_time * 1000000000 }},
        "end": "{{ timestamp.isoformat() }}",
        "kind": "event",
        "module": "juniper_srx",
        "outcome": "success",
        "severity": 14,
        "type": ["end", "allowed", "connection"]
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "juniper": {
        "srx": {
            "application": "{{ application }}",
            "connection_tag": "0",
            "dst_nat_rule_name": "None",
            "dst_nat_rule_type": "N/A",
            "encrypted": "{{ encrypted }}",
            "nat_connection_tag": "0",
            "nested_application": "UNKNOWN",
            "process": "RT_FLOW",
            "reason": "{{ reason }}",
            "roles": "N/A",
            "service_name": "{{ service_name }}",
            "session_id_32": "{{ session_id }}",
{%- if has_nat %}
            "src_nat_rule_name": "{{ nat_rule }}",
            "src_nat_rule_type": "source rule",
{%- else %}
            "src_nat_rule_name": "None",
            "src_nat_rule_type": "N/A",
{%- endif %}
            "tag": "RT_FLOW_SESSION_CLOSE",
            "username": "N/A"
        }
    },
    "log": {
        "level": "informational"
    },
    "network": {
        "bytes": {{ src_bytes + dst_bytes }},
        "iana_number": "{{ protocol_id }}",
        "packets": {{ src_packets + dst_packets }},
        "transport": "{{ transport }}"
    },
    "observer": {
        "egress": {
            "zone": "{{ egress_zone }}"
        },
        "ingress": {
            "interface": {
                "name": "{{ ingress_iface }}"
            },
            "zone": "{{ ingress_zone }}"
        },
        "name": "{{ fqdn }}",
        "product": "SRX",
        "type": "firewall",
        "vendor": "Juniper"
    },
    "process": {
        "name": "RT_FLOW"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"{% if has_nat and nat_src_ip != src_ip %}, "{{ nat_src_ip }}"{% endif %}]
    },
    "rule": {
        "name": "{{ policy_name }}"
    },
    "source": {
        "bytes": {{ src_bytes }},
        "ip": "{{ src_ip }}",
{%- if has_nat %}
        "nat": {
            "ip": "{{ nat_src_ip }}",
            "port": {{ nat_src_port }}
        },
{%- endif %}
        "packets": {{ src_packets }},
        "port": {{ src_port }}
    },
    "tags": ["juniper-srx", "forwarded"]
}