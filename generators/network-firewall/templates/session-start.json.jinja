{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- Session start events for stateful connection tracking -#}
{%- set direction_type = module.rand.weighted_choice(["outbound", "inbound", "internal"], [60, 25, 15]) -%}
{#- Pick a service -#}
{%- set service = samples.network_services.weighted_pick('weight') -%}
{#- Generate IPs -#}
{%- set src_host = samples.internal_hosts | random -%}
{%- if direction_type == "outbound" -%}
  {%- set src_ip = src_host.ip -%}
  {%- set src_port = module.rand.number.integer(49152, 65535) -%}
  {%- set dst_ip = module.rand.network.ip_v4_public() -%}
  {%- set dst_port = service.port -%}
  {%- set ingress_zone = "trust" -%}
  {%- set egress_zone = "untrust" -%}
  {%- set ingress_iface = "eth1" -%}
  {%- set egress_iface = "eth0" -%}
{%- elif direction_type == "inbound" -%}
  {%- set src_ip = module.rand.network.ip_v4_public() -%}
  {%- set src_port = module.rand.number.integer(49152, 65535) -%}
  {%- set dmz_host = samples.internal_hosts | selectattr("subnet", "equalto", "dmz") | list | random -%}
  {%- set dst_ip = dmz_host.ip -%}
  {%- set dst_port = service.port -%}
  {%- set ingress_zone = "untrust" -%}
  {%- set egress_zone = "dmz" -%}
  {%- set ingress_iface = "eth0" -%}
  {%- set egress_iface = "eth2" -%}
{%- else -%}
  {%- set src_ip = src_host.ip -%}
  {%- set src_port = module.rand.number.integer(49152, 65535) -%}
  {%- set srv_host = samples.internal_hosts | selectattr("role", "equalto", "server") | selectattr("subnet", "equalto", "servers") | list | random -%}
  {%- set dst_ip = srv_host.ip -%}
  {%- set dst_port = service.port -%}
  {%- set ingress_zone = "trust" -%}
  {%- set egress_zone = "trust" -%}
  {%- set ingress_iface = "eth1" -%}
  {%- set egress_iface = "eth1" -%}
{%- endif -%}
{%- set allow_rules = samples.firewall_rules | selectattr("action", "equalto", "allow") | list -%}
{%- set rule = allow_rules | random -%}
{%- set community_id = "1:" ~ module.rand.string.hex(20) -%}
{%- set session_id = module.rand.number.integer(100000, 9999999) -%}
{#- NAT translation for outbound traffic -#}
{%- set has_nat = direction_type == "outbound" and module.rand.chance(0.7) -%}
{%- if has_nat -%}
  {%- set nat_src_ip = params.get("nat_ip", "198.51.100.1") -%}
  {%- set nat_src_port = module.rand.number.integer(10000, 60000) -%}
{%- endif -%}
{#- Store session for correlation with session-end -#}
{%- set active_sessions = shared.get('active_sessions', []) -%}
{%- set session_entry = {"session_id": session_id, "src_ip": src_ip, "src_port": src_port, "dst_ip": dst_ip, "dst_port": dst_port, "protocol": service.protocol, "application": service.application, "service_name": service.name, "rule_id": rule.id, "rule_name": rule.name, "rule_ruleset": rule.ruleset, "ingress_zone": ingress_zone, "egress_zone": egress_zone, "ingress_iface": ingress_iface, "egress_iface": egress_iface, "direction": direction_type, "community_id": community_id, "start_time": timestamp.isoformat()} -%}
{%- if has_nat -%}
  {%- do session_entry.update({"nat_src_ip": nat_src_ip, "nat_src_port": nat_src_port}) -%}
{%- endif -%}
{%- do active_sessions.append(session_entry) -%}
{%- if active_sessions | length > 100 -%}{%- do active_sessions.pop(0) -%}{%- endif -%}
{%- do shared.set('active_sessions', active_sessions) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "session-start",
        "category": ["network"],
        "dataset": "firewall.session",
        "kind": "event",
        "module": "firewall",
        "outcome": "success",
        "severity": 0,
        "type": ["connection", "start"]
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "log": {
        "level": "informational"
    },
    "network": {
        "application": "{{ service.application }}",
        "community_id": "{{ community_id }}",
        "direction": "{{ direction_type }}",
        "transport": "{{ service.protocol }}",
        "type": "ipv4"
    },
    "observer": {
        "egress": {
            "interface": {
                "name": "{{ egress_iface }}"
            },
            "zone": "{{ egress_zone }}"
        },
        "hostname": "{{ hostname }}",
        "ingress": {
            "interface": {
                "name": "{{ ingress_iface }}"
            },
            "zone": "{{ ingress_zone }}"
        },
        "name": "{{ fqdn }}",
        "product": "Network Firewall",
        "serial_number": "{{ params.serial_number }}",
        "type": "firewall",
        "vendor": "Generic"
    },
{%- if has_nat %}
    "nat": {
        "source": {
            "ip": "{{ nat_src_ip }}",
            "port": {{ nat_src_port }}
        }
    },
{%- endif %}
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"{% if has_nat %}, "{{ nat_src_ip }}"{% endif %}]
    },
    "rule": {
        "id": "{{ rule.id }}",
        "name": "{{ rule.name }}",
        "ruleset": "{{ rule.ruleset }}"
    },
    "source": {
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    }
}
{%- do shared.set('record_id', (record_id + 1) % 2147483647) -%}