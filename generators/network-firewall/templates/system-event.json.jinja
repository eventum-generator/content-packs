{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- System/operational events from the firewall device itself -#}
{%- set system_events = [
  {"action": "configuration-changed", "message": "Configuration committed by admin", "severity": 3, "category": "configuration"},
  {"action": "configuration-changed", "message": "Auto-commit of scheduled policy update", "severity": 1, "category": "configuration"},
  {"action": "ha-state-change", "message": "HA state changed to active", "severity": 5, "category": "host"},
  {"action": "ha-heartbeat", "message": "HA heartbeat received from peer", "severity": 0, "category": "host"},
  {"action": "license-expiring", "message": "Threat prevention license expires in 30 days", "severity": 4, "category": "host"},
  {"action": "firmware-update", "message": "Firmware update check completed", "severity": 1, "category": "package"},
  {"action": "threat-db-update", "message": "Threat signature database updated successfully", "severity": 1, "category": "package"},
  {"action": "interface-up", "message": "Interface eth0 link state changed to up", "severity": 2, "category": "host"},
  {"action": "interface-down", "message": "Interface eth3 link state changed to down", "severity": 5, "category": "host"},
  {"action": "admin-login", "message": "Administrator admin logged in from 10.1.2.10 via SSH", "severity": 2, "category": "authentication"},
  {"action": "admin-logout", "message": "Administrator admin logged out", "severity": 1, "category": "authentication"},
  {"action": "disk-usage-warning", "message": "Log partition usage exceeds 80%", "severity": 4, "category": "host"},
  {"action": "session-table-warning", "message": "Session table utilization at 75%", "severity": 4, "category": "host"},
  {"action": "system-restart", "message": "System restart initiated by admin", "severity": 6, "category": "host"}
] -%}
{%- set sys_weights = [15, 10, 2, 20, 1, 5, 8, 5, 1, 10, 8, 3, 3, 1] -%}
{%- set evt = module.rand.weighted_choice(system_events, sys_weights) -%}
{#- Map ECS event.type based on category -#}
{%- if evt.category == "configuration" -%}
  {%- set event_type = ["change"] -%}
{%- elif evt.category == "authentication" -%}
  {%- set event_type = ["info"] -%}
{%- elif evt.category == "package" -%}
  {%- set event_type = ["info"] -%}
{%- else -%}
  {%- set event_type = ["info"] -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "{{ evt.action }}",
        "category": ["{{ evt.category }}"],
        "dataset": "firewall.system",
        "kind": "event",
        "module": "firewall",
        "outcome": "success",
        "severity": {{ evt.severity }},
        "type": {{ event_type | tojson }}
    },
    "host": {
        "name": "{{ hostname }}"
    },
    "log": {
        "level": "{{ "critical" if evt.severity >= 6 else ("error" if evt.severity >= 5 else ("warning" if evt.severity >= 3 else "informational")) }}"
    },
    "message": "{{ evt.message }}",
    "observer": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "product": "Network Firewall",
        "serial_number": "{{ params.serial_number }}",
        "type": "firewall",
        "vendor": "Generic"
    }
}
{%- do shared.set('record_id', record_id + 1) -%}