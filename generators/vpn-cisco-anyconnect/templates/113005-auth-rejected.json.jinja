{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{#- Random or sample username â€” attackers may try non-existent users -#}
{%- set use_real_user = module.rand.chance(0.7) -%}
{%- if use_real_user -%}
  {%- set user = (samples.usernames | random).username -%}
{%- else -%}
  {%- set user = module.rand.choice(["admin", "administrator", "root", "test", "vpnuser", "guest", "backup"]) -%}
{%- endif -%}
{%- set client_ip = module.rand.network.ip_v4_public() -%}
{#- Rejection reason -#}
{%- set rejection = module.rand.weighted_choice(
  ["Invalid password", "User not found", "Account disabled", "AAA server unavailable", "Account locked", "Simultaneous logins exceeded"],
  [60, 15, 10, 8, 5, 2]
) -%}
{#- AAA server -#}
{%- set aaa_server_ip = module.rand.weighted_choice(["10.1.1.100", "10.1.1.101"], [80, 20]) -%}
{%- set syslog_msg = "%ASA-4-113005: AAA user authentication Rejected : reason = " ~ rejection ~ " : server = " ~ aaa_server_ip ~ " : User = " ~ user ~ " : user IP = " ~ client_ip -%}
{%- set pri = 164 -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "cisco": {
        "asa": {
            "aaa_type": "authentication",
            "message_id": "113005",
            "rejection_reason": "{{ rejection }}"
        }
    },
    "data_stream": {
        "dataset": "cisco_asa.log",
        "namespace": "default",
        "type": "logs"
    },
    "destination": {
        "address": "{{ aaa_server_ip }}",
        "ip": "{{ aaa_server_ip }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "logon-failed",
        "category": ["authentication", "network"],
        "code": "113005",
        "dataset": "cisco_asa.log",
        "kind": "event",
        "module": "cisco_asa",
        "original": "<{{ pri }}>{{ timestamp.strftime('%b %d %Y %H:%M:%S') }} {{ hostname }} : {{ syslog_msg }}",
        "outcome": "failure",
        "severity": 4,
        "type": ["denied", "info"]
    },
    "host": {
        "hostname": "{{ hostname }}"
    },
    "log": {
        "level": "warning",
        "syslog": {
            "facility": {
                "code": 20
            },
            "priority": {{ pri }},
            "severity": {
                "code": 4
            }
        }
    },
    "observer": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "product": "asa",
        "type": "firewall",
        "vendor": "Cisco"
    },
    "related": {
        "hosts": ["{{ hostname }}"],
        "ip": ["{{ client_ip }}", "{{ aaa_server_ip }}"],
        "user": ["{{ user }}"]
    },
    "source": {
        "address": "{{ client_ip }}",
        "ip": "{{ client_ip }}",
        "user": {
            "name": "{{ user }}"
        }
    },
    "tags": ["cisco-asa", "forwarded"]
}
{%- do shared.set('record_id', (record_id + 1) % 2147483647) -%}
