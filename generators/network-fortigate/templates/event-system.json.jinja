{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.domain -%}
{%- set devid = params.serial_number -%}
{%- set vd = params.get('vdom', 'root') -%}
{#- System events: admin login/logout, config changes, HA, firmware -#}
{%- set system_events = [
  {"logid": "0100032001", "logdesc": "Admin login successful", "action": "login", "status": "success", "msg": "Administrator admin logged in successfully from console", "level": "information", "ui": "console", "user": "admin", "profile": "super_admin"},
  {"logid": "0100032001", "logdesc": "Admin login successful", "action": "login", "status": "success", "msg": "Administrator net-admin logged in successfully from ssh(10.1.2.10)", "level": "information", "ui": "ssh(10.1.2.10)", "user": "net-admin", "profile": "read_write"},
  {"logid": "0100032001", "logdesc": "Admin login successful", "action": "login", "status": "success", "msg": "Administrator admin logged in successfully from https(10.1.1.50)", "level": "information", "ui": "https(10.1.1.50)", "user": "admin", "profile": "super_admin"},
  {"logid": "0100032002", "logdesc": "Admin login failed", "action": "login", "status": "failure", "msg": "Administrator admin login failed from https(10.1.1.30) because of invalid password", "level": "warning", "ui": "https(10.1.1.30)", "user": "admin", "profile": "super_admin"},
  {"logid": "0100032003", "logdesc": "Admin logout successful", "action": "logout", "status": "success", "msg": "Administrator admin logged out from console", "level": "information", "ui": "console", "user": "admin", "profile": "super_admin"},
  {"logid": "0100032005", "logdesc": "Configuration changed", "action": "config-change", "status": "success", "msg": "Configuration is changed in the admin session", "level": "information", "ui": "https(10.1.1.50)", "user": "admin", "profile": "super_admin"},
  {"logid": "0100032005", "logdesc": "Configuration changed", "action": "config-change", "status": "success", "msg": "Object attribute configured", "level": "information", "ui": "console", "user": "admin", "profile": "super_admin"},
  {"logid": "0100044546", "logdesc": "Firmware upgrade", "action": "firmware-upgrade", "status": "success", "msg": "Firmware upgrade check completed", "level": "notice", "ui": "system", "user": "", "profile": ""},
  {"logid": "0100032102", "logdesc": "FortiGuard update", "action": "update", "status": "success", "msg": "Succeeded to update AV engine to 6.00294", "level": "information", "ui": "system", "user": "", "profile": ""},
  {"logid": "0100032102", "logdesc": "FortiGuard update", "action": "update", "status": "success", "msg": "Succeeded to update IPS package to 25.01050", "level": "information", "ui": "system", "user": "", "profile": ""},
  {"logid": "0100032102", "logdesc": "FortiGuard update", "action": "update", "status": "success", "msg": "Succeeded to update web filter database", "level": "information", "ui": "system", "user": "", "profile": ""},
  {"logid": "0100032100", "logdesc": "HA heartbeat", "action": "ha-heartbeat", "status": "success", "msg": "HA heartbeat received from peer", "level": "notice", "ui": "system", "user": "", "profile": ""},
  {"logid": "0100032101", "logdesc": "HA state change", "action": "ha-state-change", "status": "success", "msg": "HA state changed from standby to active", "level": "warning", "ui": "system", "user": "", "profile": ""}
] -%}
{%- set sys_weights = [10, 8, 8, 3, 8, 10, 8, 2, 8, 8, 8, 15, 2] -%}
{%- set evt = module.rand.weighted_choice(system_events, sys_weights) -%}
{#- Determine ECS event classification -#}
{%- if evt.action == "login" or evt.action == "logout" -%}
  {%- set event_category = ["authentication"] -%}
  {%- set event_type = ["start"] if evt.action == "login" else ["end"] -%}
  {%- set event_outcome = evt.status -%}
{%- elif evt.action == "config-change" -%}
  {%- set event_category = ["configuration"] -%}
  {%- set event_type = ["change"] -%}
  {%- set event_outcome = "success" -%}
{%- else -%}
  {%- set event_category = ["host"] -%}
  {%- set event_type = ["info"] -%}
  {%- set event_outcome = "success" -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "{{ evt.action }}",
        "category": {{ event_category | tojson }},
        "code": "{{ evt.logid }}",
        "dataset": "fortinet_fortigate.log",
        "kind": "event",
        "module": "fortinet_fortigate",
        "outcome": "{{ event_outcome }}",
        "type": {{ event_type | tojson }}
    },
    "fortinet": {
        "firewall": {
            "action": "{{ evt.action }}",
            "logdesc": "{{ evt.logdesc }}",
            "status": "{{ evt.status }}",
            "subtype": "system",
            "type": "event",
{%- if evt.ui %}
            "ui": "{{ evt.ui }}",
{%- endif %}
            "vd": "{{ vd }}"
        }
    },
    "log": {
        "level": "{{ evt.level }}"
    },
    "message": "{{ evt.msg }}",
    "observer": {
        "name": "{{ hostname }}",
        "product": "Fortigate",
        "serial_number": "{{ devid }}",
        "type": "firewall",
        "vendor": "Fortinet"
    },
{%- if evt.user %}
    "related": {
        "user": ["{{ evt.user }}"]
    },
    "source": {
        "user": {
            "name": "{{ evt.user }}"
        }
    },
    "user": {
        "name": "{{ evt.user }}"
    },
{%- endif %}
    "tags": ["fortinet-fortigate", "fortinet-firewall", "forwarded"]
}
