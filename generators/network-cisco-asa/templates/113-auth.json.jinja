{%- set hostname = params.hostname -%}

{#- Auth event type selection -#}
{%- set auth_event = module.rand.weighted_choice(
  ["113004", "113005", "113012", "611101", "611102"],
  [40, 15, 20, 15, 10]
) -%}

{#- Select user -#}
{%- set user = samples.vpn_users | random -%}

{#- Server IP for remote auth -#}
{%- set srv_hosts = [] -%}
{%- for h in samples.internal_hosts -%}
  {%- if h.role == "server" and h.subnet == "servers" -%}
    {%- do srv_hosts.append(h) -%}
  {%- endif -%}
{%- endfor -%}
{%- set auth_server = srv_hosts | random -%}

{#- Client IP -#}
{%- set client_ip = module.rand.network.ip_v4_public() -%}

{#- Build event based on message ID -#}
{%- if auth_event == "113004" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "success" -%}
  {%- set action = "logged-in" -%}
  {%- set event_type_list = '["allowed", "info"]' -%}
  {%- set aaa_type = "authentication" -%}
  {%- set original_msg = "%ASA-6-113004: AAA user authentication Successful : server = " ~ auth_server.ip ~ " : user = " ~ user.username -%}
{%- elif auth_event == "113005" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "failure" -%}
  {%- set action = "logon-failed" -%}
  {%- set event_type_list = '["denied", "info"]' -%}
  {%- set aaa_type = "authentication" -%}
  {%- set reason = module.rand.choice(["Unspecified", "Invalid password", "Account disabled", "Account locked"]) -%}
  {%- set original_msg = "%ASA-6-113005: AAA user authentication Rejected : reason = " ~ reason ~ " : server = " ~ auth_server.ip ~ " : user = " ~ user.username ~ " : user IP = " ~ client_ip -%}
{%- elif auth_event == "113012" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "success" -%}
  {%- set action = "logged-in" -%}
  {%- set event_type_list = '["allowed", "info"]' -%}
  {%- set aaa_type = "authentication" -%}
  {%- set original_msg = "%ASA-6-113012: AAA user authentication Successful : local database : user = " ~ user.username -%}
{%- elif auth_event == "611101" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "success" -%}
  {%- set action = "logged-in" -%}
  {%- set event_type_list = '["allowed", "info"]' -%}
  {%- set aaa_type = "authentication" -%}
  {%- set original_msg = "%ASA-6-611101: User authentication succeeded: IP address: " ~ client_ip ~ ", Uname: " ~ user.username -%}
{%- elif auth_event == "611102" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "failure" -%}
  {%- set action = "logon-failed" -%}
  {%- set event_type_list = '["denied", "info"]' -%}
  {%- set aaa_type = "authentication" -%}
  {%- set original_msg = "%ASA-6-611102: User authentication failed: IP address: " ~ client_ip ~ ", Uname: " ~ user.username -%}
{%- endif -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "cisco": {
    "asa": {
      "aaa_type": "{{ aaa_type }}",
      "message_id": "{{ auth_event }}"
    }
  },
  "destination": {
    "address": "{{ auth_server.ip }}",
    "ip": "{{ auth_server.ip }}"
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "{{ action }}",
    "category": ["authentication", "network"],
    "code": "{{ auth_event }}",
    "dataset": "cisco_asa.log",
    "kind": "event",
    "module": "cisco_asa",
    "original": "{{ timestamp.strftime('%b %d %Y %H:%M:%S') }} {{ hostname }} : {{ original_msg }}",
    "outcome": "{{ outcome }}",
    "severity": {{ severity }},
    "type": {{ event_type_list }}
  },
  "log": {
    "level": "{{ log_level }}"
  },
  "observer": {
    "hostname": "{{ hostname }}",
    "product": "asa",
    "type": "firewall",
    "vendor": "Cisco"
  },
  "related": {
    "ip": ["{{ client_ip }}", "{{ auth_server.ip }}"],
    "user": ["{{ user.username }}"]
  },
  "source": {
    "address": "{{ client_ip }}",
    "ip": "{{ client_ip }}",
    "user": {
      "name": "{{ user.username }}"
    }
  },
  "tags": ["cisco-asa", "forwarded"]
}