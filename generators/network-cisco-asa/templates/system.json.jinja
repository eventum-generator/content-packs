{%- set hostname = params.hostname -%}

{#- System event type selection -#}
{%- set sys_event = module.rand.weighted_choice(
  ["199005", "111010", "111009"],
  [40, 35, 25]
) -%}

{#- Admin user for system events -#}
{%- set admin_user = module.rand.choice(["admin", "netadmin", "enable_15"]) -%}

{#- Terminal/session for system events -#}
{%- set terminal = module.rand.choice(["console", "ssh", "https"]) -%}

{#- Client IP for remote sessions -#}
{%- set client_ip = module.rand.network.ip_v4_private_c() -%}

{#- Build event based on message ID -#}
{%- if sys_event == "199005" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set action = "configuration" -%}
  {%- set event_category = '["configuration"]' -%}
  {%- set event_type = '["change"]' -%}
  {%- set outcome = "success" -%}
  {%- set original_msg = "%ASA-6-199005: System configuration has been changed by " ~ admin_user ~ " at " ~ terminal -%}
{%- elif sys_event == "111010" -%}
  {%- set severity = 5 -%}
  {%- set log_level = "notification" -%}
  {%- set action = "configuration" -%}
  {%- set event_category = '["configuration"]' -%}
  {%- set event_type = '["change"]' -%}
  {%- set outcome = "success" -%}
  {%- set command = module.rand.choice([
    "logging enable",
    "write memory",
    "show running-config",
    "interface GigabitEthernet0/0",
    "access-list acl_out permit tcp any any eq 443",
    "no shutdown"
  ]) -%}
  {%- set original_msg = "%ASA-5-111010: User '" ~ admin_user ~ "', running 'CLI' from IP " ~ client_ip ~ ", executed '" ~ command ~ "'" -%}
{%- elif sys_event == "111009" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set action = "configuration" -%}
  {%- set event_category = '["configuration"]' -%}
  {%- set event_type = '["info"]' -%}
  {%- set outcome = "success" -%}
  {%- set command = module.rand.choice([
    "show version",
    "show conn count",
    "show failover",
    "show crypto ikev2 sa",
    "show vpn-sessiondb anyconnect"
  ]) -%}
  {%- set original_msg = "%ASA-6-111009: User '" ~ admin_user ~ "' executed cmd: " ~ command -%}
{%- endif -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "cisco": {
    "asa": {
      "message_id": "{{ sys_event }}"{% if sys_event in ["111010", "111009"] %},
      "command_line_arguments": "{{ command }}"{% endif %}
    }
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "{{ action }}",
    "category": {{ event_category }},
    "code": "{{ sys_event }}",
    "dataset": "cisco_asa.log",
    "kind": "event",
    "module": "cisco_asa",
    "original": "{{ timestamp.strftime('%b %d %Y %H:%M:%S') }} {{ hostname }} : {{ original_msg }}",
    "outcome": "{{ outcome }}",
    "severity": {{ severity }},
    "type": {{ event_type }}
  },
  "log": {
    "level": "{{ log_level }}"
  },
  "observer": {
    "hostname": "{{ hostname }}",
    "product": "asa",
    "type": "firewall",
    "vendor": "Cisco"
  },
  "related": {
    "user": ["{{ admin_user }}"]{% if sys_event == "111010" %},
    "ip": ["{{ client_ip }}"]{% endif %}
  },{% if sys_event == "111010" %}
  "source": {
    "address": "{{ client_ip }}",
    "ip": "{{ client_ip }}"
  },{% endif %}
  "user": {
    "name": "{{ admin_user }}"
  },
  "tags": ["cisco-asa", "forwarded"]
}