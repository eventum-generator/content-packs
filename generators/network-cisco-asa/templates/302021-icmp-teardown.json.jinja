{%- set hostname = params.hostname -%}

{#- Consume from icmp_sessions pool for correlation -#}
{%- set icmp_sessions = shared.get('icmp_sessions', []) -%}
{%- if icmp_sessions | length > 0 -%}
  {%- set session = icmp_sessions.pop(0) -%}
  {%- do shared.set('icmp_sessions', icmp_sessions) -%}
  {%- set foreign_ip = session.foreign_ip -%}
  {%- set global_ip = session.global_ip -%}
  {%- set local_ip = session.local_ip -%}
  {%- set icmp_id = session.icmp_id -%}
  {%- set icmp_type = session.icmp_type -%}
  {%- set icmp_code = session.icmp_code -%}
{%- else -%}
  {#- Fallback: generate standalone teardown -#}
  {%- set foreign_ip = module.rand.network.ip_v4_public() -%}
  {%- set src_host = samples.internal_hosts | random -%}
  {%- set local_ip = src_host.ip -%}
  {%- set global_ip = local_ip -%}
  {%- set icmp_id = module.rand.number.integer(0, 65535) -%}
  {%- set icmp_type = module.rand.weighted_choice([8, 0, 3, 11], [35, 35, 20, 10]) -%}
  {%- set icmp_code = 0 -%}
{%- endif -%}

{#- Build original syslog message -#}
{%- set original_msg = "%ASA-6-302021: Teardown ICMP connection for faddr " ~ foreign_ip ~ "/" ~ icmp_id ~ " gaddr " ~ global_ip ~ "/" ~ icmp_id ~ " laddr " ~ local_ip ~ "/" ~ icmp_id ~ " type " ~ icmp_type ~ " code " ~ icmp_code -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "cisco": {
    "asa": {
      "icmp_code": {{ icmp_code }},
      "icmp_type": {{ icmp_type }},
      "message_id": "302021"
    }
  },
  "destination": {
    "address": "{{ foreign_ip }}",
    "ip": "{{ foreign_ip }}"
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "flow-expiration",
    "category": ["network"],
    "code": "302021",
    "dataset": "cisco_asa.log",
    "kind": "event",
    "module": "cisco_asa",
    "original": "{{ timestamp.strftime('%b %d %Y %H:%M:%S') }} {{ hostname }} : {{ original_msg }}",
    "outcome": "success",
    "severity": 6,
    "type": ["connection", "end"]
  },
  "log": {
    "level": "informational"
  },
  "network": {
    "iana_number": "1",
    "transport": "icmp"
  },
  "observer": {
    "hostname": "{{ hostname }}",
    "product": "asa",
    "type": "firewall",
    "vendor": "Cisco"
  },
  "related": {
    "ip": ["{{ local_ip }}", "{{ foreign_ip }}"{% if global_ip != local_ip %}, "{{ global_ip }}"{% endif %}]
  },
  "source": {
    "address": "{{ local_ip }}",
    "ip": "{{ local_ip }}"
  },
  "tags": ["cisco-asa", "forwarded"]
}