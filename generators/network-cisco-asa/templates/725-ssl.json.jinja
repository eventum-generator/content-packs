{%- set hostname = params.hostname -%}

{#- SSL event type selection -#}
{%- set ssl_event = module.rand.weighted_choice(
  ["725001", "725002", "725007"],
  [40, 40, 20]
) -%}

{#- Peer type -#}
{%- set peer_type = module.rand.weighted_choice(["client", "server"], [70, 30]) -%}

{#- Source and destination -#}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{%- set src_port = module.rand.number.integer(49152, 65535) -%}
{%- set src_iface = "outside" -%}

{#- Destination is the ASA's VPN/management interface -#}
{%- set dmz_hosts = [] -%}
{%- for h in samples.internal_hosts -%}
  {%- if h.subnet == "dmz" -%}
    {%- do dmz_hosts.append(h) -%}
  {%- endif -%}
{%- endfor -%}
{%- set dst_host = dmz_hosts | random -%}
{%- set dst_ip = dst_host.ip -%}
{%- set dst_port = 443 -%}

{#- TLS version -#}
{%- set tls_version = module.rand.weighted_choice(
  ["TLSv1.2", "TLSv1.3"],
  [40, 60]
) -%}

{#- Build event based on message ID -#}
{%- if ssl_event == "725001" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "success" -%}
  {%- set event_type_list = '["connection", "start"]' -%}
  {%- set original_msg = "%ASA-6-725001: Starting SSL handshake with " ~ peer_type ~ " " ~ src_iface ~ ":" ~ src_ip ~ "/" ~ src_port ~ " to " ~ dst_ip ~ "/" ~ dst_port ~ " for " ~ tls_version ~ " session" -%}
{%- elif ssl_event == "725002" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "success" -%}
  {%- set event_type_list = '["connection", "info"]' -%}
  {%- set original_msg = "%ASA-6-725002: Device completed SSL handshake with " ~ peer_type ~ " " ~ src_iface ~ ":" ~ src_ip ~ "/" ~ src_port ~ " to " ~ dst_ip ~ "/" ~ dst_port ~ " for " ~ tls_version ~ " session" -%}
{%- elif ssl_event == "725007" -%}
  {%- set severity = 6 -%}
  {%- set log_level = "informational" -%}
  {%- set outcome = "failure" -%}
  {%- set event_type_list = '["connection", "end"]' -%}
  {%- set original_msg = "%ASA-6-725007: SSL session with " ~ peer_type ~ " " ~ src_iface ~ ":" ~ src_ip ~ "/" ~ src_port ~ " to " ~ dst_ip ~ "/" ~ dst_port ~ " terminated" -%}
{%- endif -%}

{
  "@timestamp": "{{ timestamp.isoformat() }}",
  "cisco": {
    "asa": {
      "message_id": "{{ ssl_event }}",
      "peer_type": "{{ peer_type }}",
      "source_interface": "{{ src_iface }}"
    }
  },
  "destination": {
    "address": "{{ dst_ip }}",
    "ip": "{{ dst_ip }}",
    "port": {{ dst_port }}
  },
  "ecs": {
    "version": "8.17.0"
  },
  "event": {
    "action": "ssl-handshake",
    "category": ["network"],
    "code": "{{ ssl_event }}",
    "dataset": "cisco_asa.log",
    "kind": "event",
    "module": "cisco_asa",
    "original": "{{ timestamp.strftime('%b %d %Y %H:%M:%S') }} {{ hostname }} : {{ original_msg }}",
    "outcome": "{{ outcome }}",
    "severity": {{ severity }},
    "type": {{ event_type_list }}
  },
  "log": {
    "level": "{{ log_level }}"
  },
  "observer": {
    "hostname": "{{ hostname }}",
    "ingress": {
      "interface": {
        "name": "{{ src_iface }}"
      }
    },
    "product": "asa",
    "type": "firewall",
    "vendor": "Cisco"
  },
  "related": {
    "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
  },
  "source": {
    "address": "{{ src_ip }}",
    "ip": "{{ src_ip }}",
    "port": {{ src_port }}
  },
  "tags": ["cisco-asa", "forwarded"],
  "tls": {
    "version": "{{ tls_version | replace('TLSv', '') }}",
    "version_protocol": "tls"
  }
}