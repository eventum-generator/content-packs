{%- set kevent_log_seq = shared.get('kevent_log_seq', 1200) -%}
{%- set log_id = "0701" ~ ("000000" ~ (kevent_log_seq | string))[-6:] -%}
{#- Admin user -#}
{%- set admin_user = module.rand.weighted_choice(["admin", "fml-admin", "sec-admin", "readonly"], [60, 20, 15, 5]) -%}
{#- Action -#}
{%- set action = module.rand.weighted_choice(["login", "logout"], [70, 30]) -%}
{#- Status -#}
{%- if action == "login" -%}
  {%- set status = module.rand.weighted_choice(["success", "failure"], [85, 15]) -%}
{%- else -%}
  {%- set status = "success" -%}
{%- endif -%}
{#- UI source -#}
{%- set admin_ip = module.rand.network.ip_v4_private_c() -%}
{%- set ui_type = module.rand.weighted_choice(["GUI", "ssh", "CLI"], [70, 20, 10]) -%}
{%- if ui_type == "CLI" -%}
  {%- set ui_val = "console" -%}
  {%- set has_source_ip = false -%}
{%- else -%}
  {%- set ui_val = ui_type ~ "(" ~ admin_ip ~ ")" -%}
  {%- set has_source_ip = true -%}
{%- endif -%}
{#- Network protocol from UI -#}
{%- if ui_type == "GUI" -%}
  {%- set net_protocol = "http" -%}
{%- elif ui_type == "ssh" -%}
  {%- set net_protocol = "ssh" -%}
{%- else -%}
  {%- set net_protocol = "" -%}
{%- endif -%}
{#- Event message -#}
{%- if action == "login" and status == "success" -%}
  {%- set msg = "User " ~ admin_user ~ " login successfully from " ~ ui_val -%}
{%- elif action == "login" and status == "failure" -%}
  {%- set msg = "User " ~ admin_user ~ " login failed from " ~ ui_val -%}
{%- else -%}
  {%- set msg = "User " ~ admin_user ~ " logout from " ~ ui_val -%}
{%- endif -%}
{#- ECS outcome -#}
{%- if status == "success" -%}
  {%- set outcome = "success" -%}
{%- else -%}
  {%- set outcome = "failure" -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "action": "{{ action }}",
        "category": ["authentication"],
        "code": "{{ log_id }}",
        "dataset": "fortinet_fortimail.log",
        "kind": "event",
        "module": "fortinet_fortimail",
        "outcome": "{{ outcome }}",
        "type": ["end", "info"]
    },
    "fortinet_fortimail": {
        "log": {
            "action": "{{ action }}",
            "id": "{{ log_id }}",
            "message": "{{ msg }}",
            "priority": "information",
            "reason": "none",
            "status": "{{ status }}",
            "sub_type": "admin",
            "type": "kevent",
            "ui": "{{ ui_val }}",
            "user": "{{ admin_user }}"
        }
    },
    "log": {
        "level": "information",
        "syslog": {
            "priority": 190
        }
    },
    "message": "{{ msg }}",
{% if net_protocol %}
    "network": {
        "protocol": "{{ net_protocol }}"
    },
{% endif %}
    "observer": {
        "product": "FortiMail",
        "serial_number": "{{ params.device_id }}",
        "type": "firewall",
        "vendor": "Fortinet"
    },
    "related": {
{% if has_source_ip %}
        "ip": ["{{ admin_ip }}"],
{% endif %}
        "user": ["{{ admin_user }}"]
    },
{% if has_source_ip %}
    "source": {
        "ip": "{{ admin_ip }}"
    },
{% endif %}
    "user": {
        "name": ["{{ admin_user }}"]
    },
    "tags": ["fortinet-fortimail", "forwarded"]
}
{%- do shared.set('kevent_log_seq', (kevent_log_seq + 1) % 2147483647) -%}
