{%- set session_seq = shared.get('session_seq', 1000) -%}
{%- set stats_log_seq = shared.get('stats_log_seq', 4500) -%}
{#- Session ID -#}
{%- set pfx = module.rand.string.letters(7) -%}
{%- set c1 = module.rand.choice("abcdefghijkmnpqrstuvwxyz") -%}
{%- set c2 = module.rand.choice("bcdefghjkmnpqrstuvwxyz") -%}
{%- set seq_str = ("000000" ~ (session_seq | string))[-6:] -%}
{%- set session_id = pfx ~ c1 ~ seq_str ~ "-" ~ pfx ~ c2 ~ seq_str -%}
{%- set log_id = "02" ~ ("00000000" ~ (stats_log_seq | string))[-8:] -%}
{#- Failure type determines classifier, disposition, resolved -#}
{%- set failure_type = module.rand.weighted_choice(["spf", "dkim", "dmarc", "recipient", "greylist"], [25, 15, 20, 25, 15]) -%}
{%- if failure_type == "spf" -%}
  {%- set classifier = module.rand.weighted_choice(["SPF Check", "SPF Failure as Spam", "SPF Sender Alignment"], [50, 30, 20]) -%}
  {%- set disposition = module.rand.weighted_choice(["Reject", "Modify Subject"], [60, 40]) -%}
  {%- set resolved_val = "OK" -%}
  {%- set outcome = "success" -%}
{%- elif failure_type == "dkim" -%}
  {%- set classifier = "DKIM Failure" -%}
  {%- set disposition = module.rand.weighted_choice(["Reject", "Modify Subject"], [50, 50]) -%}
  {%- set resolved_val = "OK" -%}
  {%- set outcome = "success" -%}
{%- elif failure_type == "dmarc" -%}
  {%- set classifier = "DMARC" -%}
  {%- set disposition = module.rand.weighted_choice(["Reject", "Quarantine to Review", "Modify Subject"], [50, 30, 20]) -%}
  {%- set resolved_val = "OK" -%}
  {%- set outcome = "success" -%}
{%- elif failure_type == "recipient" -%}
  {%- set classifier = "Recipient Verification" -%}
  {%- set disposition = "Reject" -%}
  {%- set resolved_val = "OK" -%}
  {%- set outcome = "success" -%}
{%- else -%}
  {%- set classifier = "Grey List" -%}
  {%- set disposition = "Defer" -%}
  {%- set resolved_val = "OK" -%}
  {%- set outcome = "success" -%}
{%- endif -%}
{#- Sender -#}
{%- set sender_email = module.faker.locale.en_US.email() -%}
{#- Recipient -#}
{%- if failure_type == "recipient" -%}
  {%- set recipient_email = module.faker.locale.en_US.user_name() ~ "@" ~ params.domain -%}
{%- else -%}
  {%- set recipient = (samples.internal_users | random).username -%}
  {%- set recipient_email = recipient ~ "@" ~ params.domain -%}
{%- endif -%}
{#- Subject -#}
{%- set subject_cat = module.rand.weighted_choice(["business", "automated", "spam"], [40, 30, 30]) -%}
{%- set subject = (samples.subjects | selectattr("category", "equalto", subject_cat) | list | random).text -%}
{#- Client info -#}
{%- set client_ip = module.rand.network.ip_v4_public() -%}
{%- set use_hostname = module.rand.chance(0.5) -%}
{%- if use_hostname -%}
  {%- set srv_items = [] -%}
  {%- set srv_weights = [] -%}
  {%- for srv in samples.mail_servers -%}
    {%- do srv_items.append(srv) -%}
    {%- do srv_weights.append(srv.weight) -%}
  {%- endfor -%}
  {%- set server = module.rand.weighted_choice(srv_items, srv_weights) -%}
  {%- set client_name = server.hostname -%}
  {%- set client_cc = server.cc -%}
{%- else -%}
  {%- set client_name = "[" ~ client_ip ~ "]" -%}
  {%- set client_cc = module.rand.weighted_choice(["US", "DE", "GB", "FR", "CN", "RU", "BR", "NL"], [20, 12, 10, 8, 12, 10, 8, 6]) -%}
{%- endif -%}
{%- set mailer = "mta" -%}
{%- set polid = module.rand.weighted_choice(["0:1:1:SYSTEM", "1:1:2:SYSTEM", "3:1:5:SYSTEM"], [40, 35, 25]) -%}
{#- Metrics -#}
{%- set message_length = module.rand.number.integer(500, 50000) -%}
{%- set scan_time = module.rand.number.floating(0.01, 0.5) | round(6) -%}
{%- set xfer_time = module.rand.number.floating(0.001, 0.03) | round(6) -%}
{%- set message_id = module.rand.string.hex(12) ~ "@" ~ module.faker.locale.en_US.domain_name() -%}
{%- set tld = params.domain.split(".")[-1] -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "ip": "{{ params.device_ip }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "email": {
        "direction": "in",
        "from": {
            "address": ["{{ sender_email }}"]
        },
        "subject": "{{ subject }}",
        "to": {
            "address": ["{{ recipient_email }}"]
        },
        "x_mailer": "{{ mailer }}"
    },
    "event": {
        "code": "{{ log_id }}",
        "dataset": "fortinet_fortimail.log",
        "kind": "event",
        "module": "fortinet_fortimail",
        "outcome": "{{ outcome }}"
    },
    "fortinet_fortimail": {
        "log": {
            "classifier": "{{ classifier }}",
            "client": {
                "cc": "{{ client_cc }}",
                "ip": "{{ client_ip }}",
                "name": "{{ client_name }}"
            },
            "destination_ip": "{{ params.device_ip }}",
            "direction": "in",
            "disposition": "{{ disposition }}",
            "domain": "{{ params.domain }}",
            "from": "{{ sender_email }}",
            "hfrom": "{{ sender_email }}",
            "id": "{{ log_id }}",
            "message_id": "{{ message_id }}",
            "message_length": {{ message_length }},
            "notif_delay": "0",
            "policy_id": "{{ polid }}",
            "priority": "information",
            "read_status": "",
            "recv_time": "",
            "resolved": "{{ resolved_val }}",
            "scan_time": {{ scan_time }},
            "session_id": "{{ session_id }}",
            "source": {
                "folder": "",
                "type": "ext"
            },
            "sub_type": "",
            "subject": "{{ subject }}",
            "to": "{{ recipient_email }}",
            "type": "statistics",
            "virus": "",
            "xfer_time": {{ xfer_time }}
        }
    },
    "log": {
        "level": "information",
        "syslog": {
            "priority": 190
        }
    },
    "observer": {
        "product": "FortiMail",
        "serial_number": "{{ params.device_id }}",
        "type": "firewall",
        "vendor": "Fortinet"
    },
    "related": {
        "ip": ["{{ client_ip }}", "{{ params.device_ip }}"],
        "user": ["{{ client_name }}", "{{ sender_email }}", "{{ recipient_email }}"]
    },
    "server": {
        "domain": "{{ params.domain }}",
        "registered_domain": "{{ params.domain }}",
        "top_level_domain": "{{ tld }}"
    },
    "source": {
        "ip": "{{ client_ip }}",
        "user": {
            "name": "{{ client_name }}"
        }
    },
    "tags": ["fortinet-fortimail", "forwarded"]
}
{%- do shared.set('session_seq', session_seq + 1) -%}
{%- do shared.set('stats_log_seq', stats_log_seq + 1) -%}
