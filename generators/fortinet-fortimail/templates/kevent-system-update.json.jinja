{%- set kevent_log_seq = shared.get('kevent_log_seq', 1200) -%}
{%- set log_id = "0704" ~ ("000000" ~ (kevent_log_seq | string))[-6:] -%}
{#- FortiGuard update type -#}
{%- set update_type = module.rand.weighted_choice(["avdb", "asdb", "fgdsrv", "asengine", "avengine"], [30, 25, 20, 15, 10]) -%}
{%- set version_major = module.rand.number.integer(70, 85) -%}
{%- set version_minor = module.rand.number.integer(1, 9999) -%}
{%- set version_str = version_major | string ~ "." ~ ("00000" ~ (version_minor | string))[-5:] -%}
{%- set update_month = module.rand.number.integer(1, 12) -%}
{%- set update_day = module.rand.number.integer(1, 28) -%}
{%- set update_year = module.rand.weighted_choice(["0024", "0025", "0026"], [10, 40, 50]) -%}
{%- set update_hour = module.rand.number.integer(0, 23) -%}
{%- set update_min = module.rand.number.integer(0, 59) -%}
{%- set date_str = ("00" ~ (update_month | string))[-2:] ~ "/" ~ ("00" ~ (update_day | string))[-2:] ~ "/" ~ update_year ~ " " ~ ("00" ~ (update_hour | string))[-2:] ~ ":" ~ ("00" ~ (update_min | string))[-2:] -%}
{%- if update_type == "avdb" -%}
  {%- set engine_ver = module.rand.number.integer(6, 7) | string ~ "." ~ module.rand.number.integer(100, 300) | string -%}
  {%- set msg = "Loaded avdb " ~ version_str ~ "(" ~ date_str ~ ") using av engine " ~ engine_ver ~ "." -%}
{%- elif update_type == "asdb" -%}
  {%- set msg = "Loaded antispam db " ~ version_str ~ "(" ~ date_str ~ ")." -%}
{%- elif update_type == "fgdsrv" -%}
  {%- set msg = "Connected to FortiGuard server " ~ module.rand.network.ip_v4_public() ~ ":443 successfully." -%}
{%- elif update_type == "asengine" -%}
  {%- set msg = "Updated antispam engine to version " ~ version_str ~ "." -%}
{%- else -%}
  {%- set engine_ver = module.rand.number.integer(6, 7) | string ~ "." ~ module.rand.number.integer(100, 300) | string -%}
  {%- set msg = "Updated antivirus engine to version " ~ engine_ver ~ "." -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["configuration"],
        "code": "{{ log_id }}",
        "dataset": "fortinet_fortimail.log",
        "kind": "event",
        "module": "fortinet_fortimail",
        "type": ["change"]
    },
    "fortinet_fortimail": {
        "log": {
            "id": "{{ log_id }}",
            "message": "{{ msg }}",
            "priority": "information",
            "sub_type": "update",
            "type": "kevent"
        }
    },
    "log": {
        "level": "information",
        "syslog": {
            "priority": 190
        }
    },
    "message": "{{ msg }}",
    "observer": {
        "product": "FortiMail",
        "serial_number": "{{ params.device_id }}",
        "type": "firewall",
        "vendor": "Fortinet"
    },
    "tags": ["fortinet-fortimail", "forwarded"]
}
{%- do shared.set('kevent_log_seq', kevent_log_seq + 1) -%}
