{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{#- Pick provider with realistic weights -#}
{%- set provider = module.rand.weighted_choice(
  [
    {"name": "FileSystem", "new_state": "Started"},
    {"name": "Registry", "new_state": "Started"},
    {"name": "Variable", "new_state": "Started"},
    {"name": "Function", "new_state": "Started"},
    {"name": "Alias", "new_state": "Started"},
    {"name": "Certificate", "new_state": "Started"},
    {"name": "Environment", "new_state": "Started"},
    {"name": "WSMan", "new_state": "Started"}
  ],
  [35, 20, 15, 10, 5, 5, 5, 5]
) -%}
{#- Reference active session if available -#}
{%- set sessions = shared.get('sessions', []) -%}
{%- if sessions | length > 0 -%}
  {%- set session = sessions | random -%}
  {%- set host_id = session.host_id -%}
  {%- set host_app = session.host_app -%}
  {%- set host_name_val = session.host_name -%}
  {%- set runspace_id = session.runspace_id -%}
  {%- set user = session.user -%}
  {%- set user_sid = session.user_sid -%}
  {%- set ps_version = session.ps_version -%}
  {%- set engine_version = session.engine_version -%}
{%- else -%}
  {%- set host_id = module.rand.crypto.uuid4() -%}
  {%- set host_app = "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" -%}
  {%- set host_name_val = "ConsoleHost" -%}
  {%- set runspace_id = module.rand.crypto.uuid4() -%}
  {%- set user = (samples.usernames | random).username -%}
  {%- set user_sid = params.domain_sid ~ "-" ~ module.rand.number.integer(1100, 9999) -%}
  {%- set ps_version = params.powershell_version -%}
  {%- set engine_version = params.engine_version -%}
{%- endif -%}
{%- set pipeline_id = module.rand.number.integer(1, 30) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "winlogbeat",
        "version": "{{ params.agent_version }}"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["process"],
        "code": "600",
        "kind": "event",
        "module": "powershell",
        "provider": "PowerShell",
        "sequence": {{ module.rand.number.integer(1, 999) }},
        "type": ["info"]
    },
    "host": {
        "name": "{{ hostname }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "log": {
        "level": "information"
    },
    "powershell": {
        "engine": {
            "version": "{{ engine_version }}"
        },
        "pipeline_id": "{{ pipeline_id }}",
        "process": {
            "executable_version": "{{ ps_version }}"
        },
        "provider": {
            "name": "{{ provider.name }}",
            "new_state": "{{ provider.new_state }}"
        },
        "runspace_id": "{{ runspace_id }}"
    },
    "process": {
        "args": [{{ host_app.split(' ') | map('tojson') | join(', ') }}],
        "args_count": {{ host_app.split(' ') | length }},
        "command_line": {{ host_app | tojson }},
        "entity_id": "{{ host_id }}",
        "title": "{{ host_name_val }}"
    },
    "related": {
        "user": ["{{ user }}"]
    },
    "user": {
        "domain": "{{ domain }}",
        "id": "{{ user_sid }}",
        "name": "{{ user }}"
    },
    "winlog": {
        "channel": "Windows PowerShell",
        "computer_name": "{{ fqdn }}",
        "event_id": "600",
        "keywords": ["Classic"],
        "level": "information",
        "opcode": "Info",
        "provider_name": "PowerShell",
        "record_id": "{{ record_id }}",
        "task": "Provider Lifecycle",
        "time_created": "{{ timestamp.isoformat() }}"
    }
}
{%- do shared.set('record_id', (record_id + 1) % 2147483647) -%}
