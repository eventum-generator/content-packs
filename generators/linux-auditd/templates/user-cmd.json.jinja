{%- set host = samples.hosts | random -%}
{%- set hostname = host.name -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{%- set seq = shared.get('sequence:' ~ hostname, 1000) -%}
{#- Pick the user who ran sudo -#}
{%- set u = samples.usernames | random -%}
{%- set acct_user = u.username -%}
{%- set acct_uid = u.uid | string -%}
{%- set ses = module.rand.number.integer(1, 9999) | string -%}
{%- set pid = module.rand.number.integer(1000, 65535) -%}
{%- set tty = "pts/" ~ module.rand.number.integer(0, 9) -%}
{#- Pick a command that was run via sudo -#}
{%- set sudo_cmds = [
  "systemctl restart nginx",
  "systemctl status sshd",
  "journalctl -u docker --no-pager -n 100",
  "apt-get update",
  "apt-get install -y curl",
  "cat /etc/shadow",
  "tail -f /var/log/auth.log",
  "iptables -L -n",
  "useradd -m newuser",
  "passwd deploy",
  "chmod 600 /etc/ssh/sshd_config",
  "mount /dev/sdb1 /mnt/data",
  "docker ps",
  "kill -9 " ~ module.rand.number.integer(1000, 65535) | string,
  "vim /etc/nginx/nginx.conf"
] -%}
{%- set cmd = module.rand.choice(sudo_cmds) -%}
{%- set outcome = module.rand.weighted_choice(["success", "failure"], [92, 8]) -%}
{%- set result = "success" if outcome == "success" else "fail" -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ host.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "auditbeat",
        "version": "{{ params.agent_version }}"
    },
    "auditd": {
        "data": {
            "cmd": "{{ cmd }}",
            "grantors": "pam_unix",
            "terminal": "{{ tty }}"
        },
        "message_type": "user_cmd",
        "result": "{{ result }}",
        "session": "{{ ses }}",
        "summary": {
            "actor": {
                "primary": "{{ acct_user }}",
                "secondary": "root"
            },
            "how": "/usr/bin/sudo",
            "object": {
                "primary": "{{ cmd }}",
                "type": "process"
            }
        }
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "action": "ran-command",
        "category": ["process"],
        "kind": "event",
        "module": "auditd",
        "outcome": "{{ outcome }}",
        "sequence": {{ seq }},
        "type": ["start"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "os": {
            "family": "linux",
            "kernel": "{{ host.os_kernel }}",
            "name": "{{ host.os_name }}",
            "platform": "{{ host.os_platform }}",
            "type": "linux",
            "version": "{{ host.os_version }}"
        }
    },
    "process": {
        "executable": "/usr/bin/sudo",
        "pid": {{ pid }}
    },
    "related": {
        "user": ["{{ acct_user }}"]
    },
    "service": {
        "type": "auditd"
    },
    "user": {
        "audit": {
            "id": "{{ acct_uid }}",
            "name": "{{ acct_user }}"
        },
        "id": "0",
        "name": "root"
    }
}
{%- do shared.set('sequence:' ~ hostname, (seq + 1) % 2147483647) -%}
