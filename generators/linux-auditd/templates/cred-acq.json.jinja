{%- set seq = shared.get('sequence', 1000) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{#- Try to consume from auth session pool for correlation -#}
{%- set auth_sessions = shared.get('auth_sessions', []) -%}
{%- if auth_sessions | length > 0 -%}
  {%- set session = auth_sessions.pop(0) -%}
  {%- do shared.set('auth_sessions', auth_sessions) -%}
  {%- set acct_user = session.user -%}
  {%- set acct_uid = session.uid -%}
  {%- set exe = session.exe -%}
  {%- set terminal = session.terminal -%}
  {%- set src_ip = session.src_ip -%}
  {%- set pid = session.pid -%}
  {%- set ses = session.ses -%}
{%- else -%}
  {#- Fallback: generate standalone values -#}
  {%- set u = samples.usernames | random -%}
  {%- set acct_user = u.username -%}
  {%- set acct_uid = u.uid | string -%}
  {%- set exe_choice = module.rand.weighted_choice(["sshd", "sudo", "cron", "su"], [40, 30, 20, 10]) -%}
  {%- set exe_map = {"sshd": "/usr/sbin/sshd", "sudo": "/usr/bin/sudo", "cron": "/usr/sbin/cron", "su": "/usr/bin/su"} -%}
  {%- set exe = exe_map[exe_choice] -%}
  {%- if exe_choice == "sshd" -%}
    {%- set terminal = "ssh" -%}
    {%- set src_ip = module.rand.network.ip_v4_private_c() -%}
  {%- elif exe_choice == "cron" -%}
    {%- set terminal = "cron" -%}
    {%- set src_ip = "?" -%}
  {%- else -%}
    {%- set terminal = "pts/" ~ module.rand.number.integer(0, 9) -%}
    {%- set src_ip = "?" -%}
  {%- endif -%}
  {%- set pid = module.rand.number.integer(1000, 65535) -%}
  {%- set ses = module.rand.number.integer(1, 9999) | string -%}
{%- endif -%}
{#- Store for cred-disp correlation -#}
{%- set cred_sessions = shared.get('cred_sessions', []) -%}
{%- do cred_sessions.append({"user": acct_user, "uid": acct_uid, "exe": exe, "terminal": terminal, "pid": pid, "ses": ses}) -%}
{%- if cred_sessions | length > 50 -%}{%- do cred_sessions.pop(0) -%}{%- endif -%}
{%- do shared.set('cred_sessions', cred_sessions) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "auditbeat",
        "version": "{{ params.agent_version }}"
    },
    "auditd": {
        "data": {
            "acct": "{{ acct_user }}",
            "grantors": "pam_unix",
            "op": "PAM:setcred",
            "terminal": "{{ terminal }}"
        },
        "message_type": "cred_acq",
        "result": "success",
        "session": "{{ ses }}",
        "summary": {
            "actor": {
                "primary": "{{ acct_user }}",
                "secondary": "root"
            },
            "how": "{{ exe }}",
            "object": {
                "primary": "{{ terminal }}",
                "type": "user-session"
            }
        }
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "action": "acquired-credentials",
        "category": ["authentication"],
        "kind": "event",
        "module": "auditd",
        "outcome": "success",
        "sequence": {{ seq }},
        "type": ["info"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "os": {
            "family": "linux",
            "kernel": "{{ params.os_kernel }}",
            "name": "{{ params.os_name }}",
            "platform": "{{ params.os_platform }}",
            "type": "linux",
            "version": "{{ params.os_version }}"
        }
    },
    "process": {
        "executable": "{{ exe }}",
        "pid": {{ pid }}
    },
    "related": {
        "user": ["{{ acct_user }}"]
    },
    "service": {
        "type": "auditd"
    },
    "user": {
        "audit": {
            "id": "{{ acct_uid }}",
            "name": "{{ acct_user }}"
        },
        "id": "0",
        "name": "root",
        "target": {
            "id": "{{ acct_uid }}",
            "name": "{{ acct_user }}"
        }
    }
}
{%- do shared.set('sequence', (seq + 1) % 2147483647) -%}
