{%- set seq = shared.get('sequence', 1000) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{#- Pick a service -#}
{%- set svc = samples.services | random -%}
{%- set pid = module.rand.number.integer(1, 65535) -%}
{%- set ses = "unset" -%}
{%- set auid_uid = "4294967295" -%}
{%- set outcome = module.rand.weighted_choice(["success", "failure"], [95, 5]) -%}
{%- set result = "success" if outcome == "success" else "fail" -%}
{#- Store service in pool for service-stop correlation -#}
{%- if outcome == "success" -%}
  {%- set svc_pool = shared.get('running_services', []) -%}
  {%- do svc_pool.append({"unit": svc.unit, "name": svc.name, "exe": svc.exe, "pid": pid}) -%}
  {%- if svc_pool | length > 30 -%}{%- do svc_pool.pop(0) -%}{%- endif -%}
  {%- do shared.set('running_services', svc_pool) -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "auditbeat",
        "version": "{{ params.agent_version }}"
    },
    "auditd": {
        "data": {
            "unit": "{{ svc.unit }}"
        },
        "message_type": "service_start",
        "result": "{{ result }}",
        "session": "{{ ses }}",
        "summary": {
            "actor": {
                "primary": "unset",
                "secondary": "root"
            },
            "how": "/lib/systemd/systemd",
            "object": {
                "primary": "{{ svc.unit }}",
                "type": "service"
            }
        }
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "action": "started-service",
        "category": ["process"],
        "kind": "event",
        "module": "auditd",
        "outcome": "{{ outcome }}",
        "sequence": {{ seq }},
        "type": ["start"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "os": {
            "family": "linux",
            "kernel": "{{ params.os_kernel }}",
            "name": "{{ params.os_name }}",
            "platform": "{{ params.os_platform }}",
            "type": "linux",
            "version": "{{ params.os_version }}"
        }
    },
    "process": {
        "executable": "/lib/systemd/systemd",
        "name": "systemd",
        "pid": 1
    },
    "related": {
        "user": ["root"]
    },
    "service": {
        "type": "auditd"
    },
    "user": {
        "audit": {
            "id": "{{ auid_uid }}",
            "name": "unset"
        },
        "id": "0",
        "name": "root"
    }
}
{%- do shared.set('sequence', seq + 1) -%}
