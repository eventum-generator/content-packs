{%- set seq = shared.get('sequence', 1000) -%}
{%- set hostname = params.hostname -%}
{%- set fqdn = hostname ~ '.' ~ params.fqdn_suffix -%}
{#- Try to consume from running services pool for correlation -#}
{%- set svc_pool = shared.get('running_services', []) -%}
{%- if svc_pool | length > 0 -%}
  {%- set running = svc_pool.pop(0) -%}
  {%- do shared.set('running_services', svc_pool) -%}
  {%- set unit = running.unit -%}
  {%- set svc_name = running.name -%}
  {%- set svc_exe = running.exe -%}
{%- else -%}
  {#- Fallback: generate standalone values -#}
  {%- set svc = samples.services | random -%}
  {%- set unit = svc.unit -%}
  {%- set svc_name = svc.name -%}
  {%- set svc_exe = svc.exe -%}
{%- endif -%}
{%- set ses = "unset" -%}
{%- set auid_uid = "4294967295" -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ fqdn }}",
        "type": "auditbeat",
        "version": "{{ params.agent_version }}"
    },
    "auditd": {
        "data": {
            "unit": "{{ unit }}"
        },
        "message_type": "service_stop",
        "result": "success",
        "session": "{{ ses }}",
        "summary": {
            "actor": {
                "primary": "unset",
                "secondary": "root"
            },
            "how": "/lib/systemd/systemd",
            "object": {
                "primary": "{{ unit }}",
                "type": "service"
            }
        }
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "action": "stopped-service",
        "category": ["process"],
        "kind": "event",
        "module": "auditd",
        "outcome": "success",
        "sequence": {{ seq }},
        "type": ["end"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ fqdn }}",
        "os": {
            "family": "linux",
            "kernel": "{{ params.os_kernel }}",
            "name": "{{ params.os_name }}",
            "platform": "{{ params.os_platform }}",
            "type": "linux",
            "version": "{{ params.os_version }}"
        }
    },
    "process": {
        "executable": "/lib/systemd/systemd",
        "name": "systemd",
        "pid": 1
    },
    "related": {
        "user": ["root"]
    },
    "service": {
        "type": "auditd"
    },
    "user": {
        "audit": {
            "id": "{{ auid_uid }}",
            "name": "unset"
        },
        "id": "0",
        "name": "root"
    }
}
{%- do shared.set('sequence', (seq + 1) % 2147483647) -%}
