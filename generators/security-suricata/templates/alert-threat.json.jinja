{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', (fid + module.rand.number.integer(1, 500)) % 2147483647) -%}
{%- set sig = samples.signatures_threat | random -%}
{%- set direction = module.rand.weighted_choice(["outbound", "inbound"], [60, 40]) -%}
{%- if direction == "outbound" -%}
{%- set src_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set dst_ip = module.rand.network.ip_v4_public() -%}
{%- else -%}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{%- set dst_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- endif -%}
{%- set src_port = module.rand.number.integer(32768, 65535) -%}
{%- if sig.app_proto == "http" -%}
{%- set dst_port = module.rand.weighted_choice([80, 443, 8080, 8443], [40, 30, 20, 10]) -%}
{%- set proto = "tcp" -%}
{%- else -%}
{%- set dst_port = module.rand.number.integer(1024, 65535) -%}
{%- set proto = "tcp" -%}
{%- endif -%}
{%- set action = module.rand.weighted_choice(["allowed", "denied"], [60, 40]) -%}
{%- set cid_input = (src_ip ~ ":" ~ (src_port | string) ~ "<>" ~ dst_ip ~ ":" ~ (dst_port | string) ~ "/" ~ proto).encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{%- set has_http = sig.app_proto == "http" and module.rand.chance(0.7) -%}
{%- if has_http -%}
{%- set http_method = module.rand.weighted_choice(["GET", "POST"], [40, 60]) -%}
{%- set http_url = (samples.urls | random).path -%}
{%- set http_status = module.rand.weighted_choice([200, 403, 404, 500], [50, 20, 15, 15]) -%}
{%- set http_hostname = (samples.domains | random).domain -%}
{%- set ua = (samples.user_agents | random).user_agent -%}
{%- endif -%}
{%- set has_mitre = sig.metadata.mitre_attack is defined -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
{% if has_http %}
        "domain": "{{ http_hostname }}",
{% endif %}
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network", "intrusion_detection"],
        "dataset": "suricata.eve",
        "kind": "alert",
        "module": "suricata",
        "severity": {{ sig.severity }},
        "type": ["{{ action }}"]
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
{% if has_http %}
    "http": {
        "request": {
            "method": "{{ http_method }}"
        },
        "response": {
            "status_code": {{ http_status }}
        }
    },
{% endif %}
    "message": "{{ sig.category }}",
    "network": {
        "community_id": "{{ community_id }}",
{% if sig.app_proto != "failed" %}
        "protocol": "{{ sig.app_proto }}",
{% endif %}
        "transport": "{{ proto }}"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
{% if has_http %}
        "hosts": ["{{ http_hostname }}"],
{% endif %}
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "rule": {
        "category": "{{ sig.category }}",
        "id": "{{ sig.sid }}",
        "name": "{{ sig.signature }}"
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "alert": {
                "category": "{{ sig.category }}",
                "gid": {{ sig.gid }},
                "metadata": {
                    "affected_product": {{ sig.metadata.affected_product | tojson }},
                    "attack_target": {{ sig.metadata.attack_target | tojson }},
                    "deployment": {{ sig.metadata.deployment | tojson }},
                    "performance_impact": {{ sig.metadata.performance_impact | tojson }},
                    "signature_severity": {{ sig.metadata.signature_severity | tojson }}
{% if has_mitre %}
                    ,"mitre_attack": {{ sig.metadata.mitre_attack | tojson }}
{% endif %}
                },
                "rev": {{ sig.rev }},
                "severity": {{ sig.severity }},
                "signature": "{{ sig.signature }}",
                "signature_id": {{ sig.sid }}
            },
            "event_type": "alert",
            "flow_id": "{{ fid }}",
            "in_iface": "{{ params.interface }}"
        }
    },
{% if has_mitre %}
    "threat": {
        "framework": "MITRE ATT&CK",
        "tactic": {
            "id": {{ sig.metadata.mitre_tactic_id | tojson }},
            "name": {{ sig.metadata.mitre_tactic_name | tojson }}
        },
        "technique": {
            "id": {{ sig.metadata.mitre_technique_id | tojson }}
        }
    },
{% endif %}
{% if has_http %}
    "url": {
        "domain": "{{ http_hostname }}",
        "original": "{{ http_url }}",
        "path": "{{ http_url }}"
    },
    "user_agent": {
        "original": "{{ ua }}"
    },
{% endif %}
    "tags": ["suricata"]
}
