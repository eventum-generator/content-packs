{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', fid + module.rand.number.integer(1, 500)) -%}
{%- set src_ip = module.rand.weighted_choice(
    [params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254), module.rand.network.ip_v4_public()],
    [40, 60]
) -%}
{%- set dst_ip = module.rand.weighted_choice(
    [params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254), module.rand.network.ip_v4_public()],
    [60, 40]
) -%}
{%- set src_port = module.rand.number.integer(0, 65535) -%}
{%- set dst_port = module.rand.number.integer(0, 65535) -%}
{%- set proto = module.rand.weighted_choice(["tcp", "udp", "icmp"], [50, 30, 20]) -%}
{%- set anomaly_types = {
    "decode": [
        "decoder.udp.pkt_too_small",
        "decoder.icmpv4.unknown_type",
        "decoder.ipv4.wrong_ip_version",
        "decoder.ethernet.pkt_too_small",
        "decoder.ipv4.hdr_too_small",
        "decoder.tcp.invalid_optlen",
        "decoder.ipv4.trunc_pkt"
    ],
    "stream": [
        "stream.pkt_invalid_timestamp",
        "stream.pkt_bad_window_update",
        "stream.reassembly.segment_before_base_seq",
        "stream.rst_but_no_session",
        "stream.3whs_wrong_seq",
        "stream.pkt_retransmission",
        "stream.shutting_down_tcp_session"
    ],
    "applayer": [
        "applayer.detect_protocol_only_one_direction",
        "applayer.wrong_direction_first_data",
        "applayer.proto_detection_skipped"
    ]
} -%}
{%- set anomaly_type = module.rand.weighted_choice(["decode", "stream", "applayer"], [40, 45, 15]) -%}
{%- set anomaly_event = module.rand.choice(anomaly_types[anomaly_type]) -%}
{%- set cid_input = (src_ip ~ ":" ~ (src_port | string) ~ "<>" ~ dst_ip ~ ":" ~ (dst_port | string) ~ "/" ~ proto).encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network"],
        "dataset": "suricata.eve",
        "kind": "event",
        "module": "suricata"
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
    "network": {
        "community_id": "{{ community_id }}",
        "transport": "{{ proto }}"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "anomaly": {
                "event": "{{ anomaly_event }}",
                "type": "{{ anomaly_type }}"
            },
            "event_type": "anomaly",
            "flow_id": "{{ fid }}",
            "in_iface": "{{ params.interface }}"
        }
    },
    "tags": ["suricata"]
}
