{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', (fid + module.rand.number.integer(1, 500)) % 2147483647) -%}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{%- set src_port = module.rand.weighted_choice([80, 443, 8080, 8443], [40, 30, 20, 10]) -%}
{%- set dst_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set dst_port = module.rand.number.integer(32768, 65535) -%}
{%- set proto = "tcp" -%}
{%- set domain = (samples.domains | random).domain -%}
{%- set filenames = ["/download/update.exe", "/assets/main.js", "/static/style.css", "/images/logo.png", "/api/export.csv", "/files/document.pdf", "/media/video.mp4", "/archive/backup.zip", "/lib/jquery.min.js", "/fonts/roboto.woff2"] -%}
{%- set filename = module.rand.choice(filenames) -%}
{%- set file_size = module.rand.number.integer(100, 5000000) -%}
{%- set file_state = module.rand.weighted_choice(["CLOSED", "TRUNCATED"], [90, 10]) -%}
{%- set md5 = module.rand.string.hex(32) -%}
{%- set sha1 = module.rand.string.hex(40) -%}
{%- set sha256 = module.rand.string.hex(64) -%}
{%- set method = module.rand.weighted_choice(["GET", "POST"], [80, 20]) -%}
{%- set status_code = module.rand.weighted_choice([200, 206, 301, 304], [75, 10, 5, 10]) -%}
{%- set cid_input = (dst_ip ~ ":" ~ (dst_port | string) ~ "<>" ~ src_ip ~ ":" ~ (src_port | string) ~ "/" ~ proto).encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network"],
        "dataset": "suricata.eve",
        "kind": "event",
        "module": "suricata"
    },
    "file": {
        "path": "{{ filename }}",
        "size": {{ file_size }}
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
    "http": {
        "request": {
            "method": "{{ method }}"
        },
        "response": {
            "body": {
                "bytes": {{ file_size }}
            },
            "status_code": {{ status_code }}
        }
    },
    "network": {
        "community_id": "{{ community_id }}",
        "protocol": "http",
        "transport": "{{ proto }}"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
        "hash": ["{{ sha1 }}"],
        "hosts": ["{{ domain }}"],
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "event_type": "fileinfo",
            "fileinfo": {
                "filename": "{{ filename }}",
                "gaps": false,
                "md5": "{{ md5 }}",
                "sha1": "{{ sha1 }}",
                "sha256": "{{ sha256 }}",
                "size": {{ file_size }},
                "state": "{{ file_state }}",
                "stored": false
            },
            "flow_id": "{{ fid }}",
            "in_iface": "{{ params.interface }}"
        }
    },
    "tags": ["suricata"],
    "url": {
        "domain": "{{ domain }}",
        "original": "{{ filename }}",
        "path": "{{ filename }}"
    }
}
