{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', fid + module.rand.number.integer(1, 500)) -%}
{%- set dhcp_type_weights = {"ack": 40, "offer": 25, "request": 20, "discover": 10, "release": 5} -%}
{%- set dhcp_type = module.rand.weighted_choice(dhcp_type_weights | list, dhcp_type_weights.values() | list) -%}
{%- if dhcp_type in ["discover", "request"] -%}
{%- set msg_type = "request" -%}
{%- set src_ip = "0.0.0.0" -%}
{%- set src_port = 68 -%}
{%- set dst_ip = "255.255.255.255" -%}
{%- set dst_port = 67 -%}
{%- elif dhcp_type == "release" -%}
{%- set msg_type = "request" -%}
{%- set src_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set src_port = 68 -%}
{%- set dst_ip = params.gateway_ip -%}
{%- set dst_port = 67 -%}
{%- else -%}
{%- set msg_type = "reply" -%}
{%- set src_ip = params.gateway_ip -%}
{%- set src_port = 67 -%}
{%- set dst_ip = "255.255.255.255" -%}
{%- set dst_port = 68 -%}
{%- endif -%}
{%- set client_mac = module.rand.string.hex(2) ~ ":" ~ module.rand.string.hex(2) ~ ":" ~ module.rand.string.hex(2) ~ ":" ~ module.rand.string.hex(2) ~ ":" ~ module.rand.string.hex(2) ~ ":" ~ module.rand.string.hex(2) -%}
{%- set assigned_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(100, 254) -%}
{%- set transaction_id = module.rand.number.integer(100000000, 4294967295) -%}
{%- set lease_time = module.rand.choice([3600, 7200, 43200, 86400]) -%}
{%- set hostname = module.rand.choice(["DESKTOP-", "LAPTOP-", "WS-", "PC-"]) ~ module.rand.string.letters(5) | upper -%}
{%- set cid_input = (src_ip ~ ":" ~ (src_port | string) ~ "<>" ~ dst_ip ~ ":" ~ (dst_port | string) ~ "/udp").encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network"],
        "dataset": "suricata.eve",
        "kind": "event",
        "module": "suricata"
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
    "network": {
        "community_id": "{{ community_id }}",
        "transport": "udp"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "dhcp": {
                "assigned_ip": "{{ assigned_ip }}",
                "client_mac": "{{ client_mac }}",
                "dhcp_type": "{{ dhcp_type }}",
                "dns_servers": ["{{ params.dns_server_ip }}"],
                "hostname": "{{ hostname }}",
                "id": {{ transaction_id }},
                "lease_time": {{ lease_time }},
                "routers": ["{{ params.gateway_ip }}"],
                "subnet_mask": "255.255.255.0",
                "type": "{{ msg_type }}"
            },
            "event_type": "dhcp",
            "flow_id": "{{ fid }}",
            "in_iface": "{{ params.interface }}"
        }
    },
    "tags": ["suricata"]
}
