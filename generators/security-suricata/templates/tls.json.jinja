{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', (fid + module.rand.number.integer(1, 500)) % 2147483647) -%}
{%- set src_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set src_port = module.rand.number.integer(32768, 65535) -%}
{%- set dst_ip = module.rand.network.ip_v4_public() -%}
{%- set dst_port = 443 -%}
{%- set proto = "tcp" -%}
{%- set cert = samples.tls_certs | random -%}
{%- set cid_input = (src_ip ~ ":" ~ (src_port | string) ~ "<>" ~ dst_ip ~ ":" ~ (dst_port | string) ~ "/" ~ proto).encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{%- set session_resumed = module.rand.chance(0.2) -%}
{%- set fingerprint_upper = cert.fingerprint | upper | replace(":", "") -%}
{%- set bytes_ts = module.rand.number.integer(500, 5000) -%}
{%- set bytes_tc = module.rand.number.integer(1000, 100000) -%}
{%- set pkts_ts = module.rand.number.integer(5, 30) -%}
{%- set pkts_tc = module.rand.number.integer(5, 50) -%}
{%- set flows = shared.get('flows', []) -%}
{%- do flows.append({
    "flow_id": fid,
    "src_ip": src_ip,
    "src_port": src_port,
    "dst_ip": dst_ip,
    "dst_port": dst_port,
    "proto": "TCP",
    "app_proto": "tls",
    "community_id": community_id,
    "bytes_ts": bytes_ts,
    "bytes_tc": bytes_tc,
    "pkts_ts": pkts_ts,
    "pkts_tc": pkts_tc,
    "start": timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') ~ "+0000"
}) -%}
{%- if flows | length > 200 -%}{%- do flows.pop(0) -%}{%- endif -%}
{%- do shared.set('flows', flows) -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
        "domain": "{{ cert.sni }}",
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network"],
        "dataset": "suricata.eve",
        "kind": "event",
        "module": "suricata",
        "type": ["protocol"]
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
    "network": {
        "community_id": "{{ community_id }}",
        "protocol": "tls",
        "transport": "{{ proto }}"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
        "hash": ["{{ fingerprint_upper }}", "{{ cert.ja3_hash }}", "{{ cert.ja3s_hash }}"],
        "hosts": ["{{ cert.sni }}"],
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "event_type": "tls",
            "flow_id": "{{ fid }}",
            "in_iface": "{{ params.interface }}",
            "tls": {
                "fingerprint": "{{ cert.fingerprint }}",
                "issuerdn": "{{ cert.issuer }}",
                "ja3": {
                    "hash": "{{ cert.ja3_hash }}"
                },
                "ja3s": {
                    "hash": "{{ cert.ja3s_hash }}"
                },
                "notafter": "{{ cert.not_after }}",
                "notbefore": "{{ cert.not_before }}",
                "serial": "{{ cert.serial }}",
                "session_resumed": {{ session_resumed | tojson }},
                "sni": "{{ cert.sni }}",
                "subject": "{{ cert.subject }}",
                "version": "{{ cert.version }}"
            }
        }
    },
    "tags": ["suricata"],
    "tls": {
        "client": {
            "ja3": "{{ cert.ja3_hash }}",
            "server_name": "{{ cert.sni }}"
        },
        "resumed": {{ session_resumed | tojson }},
        "server": {
            "hash": {
                "sha1": "{{ fingerprint_upper }}"
            },
            "issuer": "{{ cert.issuer }}",
            "ja3s": "{{ cert.ja3s_hash }}",
            "not_after": "{{ cert.not_after }}",
            "not_before": "{{ cert.not_before }}",
            "subject": "{{ cert.subject }}"
        },
        "version": "{{ cert.version.split(' ')[1] }}",
        "version_protocol": "{{ cert.version.split(' ')[0] | lower }}"
    }
}
