{%- set fid = shared.get('flow_id_counter', 100000000000000) -%}
{%- do shared.set('flow_id_counter', fid + module.rand.number.integer(1, 500)) -%}
{%- set src_ip = params.internal_subnet ~ "." ~ module.rand.number.integer(2, 254) -%}
{%- set src_port = module.rand.number.integer(32768, 65535) -%}
{%- set domain = (samples.domains | random).domain -%}
{%- set dst_ip = module.rand.network.ip_v4_public() -%}
{%- set dst_port_weights = {80: 40, 443: 5, 8080: 10, 8443: 5, 3000: 3, 8000: 2} -%}
{%- set dst_port = module.rand.weighted_choice(dst_port_weights | list, dst_port_weights.values() | list) -%}
{%- set proto = "tcp" -%}
{%- set method_weights = {"GET": 65, "POST": 20, "PUT": 5, "DELETE": 3, "HEAD": 3, "OPTIONS": 2, "PATCH": 2} -%}
{%- set method = module.rand.weighted_choice(method_weights | list, method_weights.values() | list) -%}
{%- set url_path = (samples.urls | random).path -%}
{%- set ua = (samples.user_agents | random).user_agent -%}
{%- set status_weights = {200: 70, 301: 5, 302: 5, 304: 8, 400: 3, 401: 2, 403: 2, 404: 3, 500: 1, 502: 0.5, 503: 0.5} -%}
{%- set status_code = module.rand.weighted_choice(status_weights | list, status_weights.values() | list) -%}
{%- set response_length = module.rand.number.integer(200, 500000) -%}
{%- set content_type_weights = {"text/html": 35, "application/json": 30, "text/javascript": 10, "text/css": 8, "image/png": 5, "application/xml": 5, "application/octet-stream": 4, "text/plain": 3} -%}
{%- set content_type = module.rand.weighted_choice(content_type_weights | list, content_type_weights.values() | list) -%}
{%- set cid_input = (src_ip ~ ":" ~ (src_port | string) ~ "<>" ~ dst_ip ~ ":" ~ (dst_port | string) ~ "/" ~ proto).encode() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(module.hashlib.sha1(cid_input).digest()).decode() -%}
{%- if status_code | int < 400 -%}
{%- set outcome = "success" -%}
{%- else -%}
{%- set outcome = "failure" -%}
{%- endif -%}
{%- set bytes_ts = module.rand.number.integer(200, 2000) -%}
{%- set bytes_tc = response_length + module.rand.number.integer(100, 500) -%}
{%- set pkts_ts = module.rand.number.integer(3, 20) -%}
{%- set pkts_tc = module.rand.number.integer(3, 50) -%}
{%- set flows = shared.get('flows', []) -%}
{%- do flows.append({
    "flow_id": fid,
    "src_ip": src_ip,
    "src_port": src_port,
    "dst_ip": dst_ip,
    "dst_port": dst_port,
    "proto": "TCP",
    "app_proto": "http",
    "community_id": community_id,
    "bytes_ts": bytes_ts,
    "bytes_tc": bytes_tc,
    "pkts_ts": pkts_ts,
    "pkts_tc": pkts_tc,
    "start": timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') ~ "+0000"
}) -%}
{%- if flows | length > 200 -%}{%- do flows.pop(0) -%}{%- endif -%}
{%- do shared.set('flows', flows) -%}
{
    "@timestamp": "{{ timestamp.strftime('%Y-%m-%dT%H:%M:%S.%f') }}Z",
    "agent": {
        "id": "{{ params.agent_id }}",
        "name": "{{ params.hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "destination": {
        "address": "{{ dst_ip }}",
        "domain": "{{ domain }}",
        "ip": "{{ dst_ip }}",
        "port": {{ dst_port }}
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network", "web"],
        "dataset": "suricata.eve",
        "kind": "event",
        "module": "suricata",
        "outcome": "{{ outcome }}",
        "type": ["access", "protocol"]
    },
    "host": {
        "hostname": "{{ params.hostname }}",
        "name": "{{ params.hostname }}"
    },
    "http": {
        "request": {
            "method": "{{ method }}"
        },
        "response": {
            "body": {
                "bytes": {{ response_length }}
            },
            "status_code": {{ status_code }}
        }
    },
    "network": {
        "community_id": "{{ community_id }}",
        "protocol": "http",
        "transport": "{{ proto }}"
    },
    "observer": {
        "hostname": "{{ params.hostname }}",
        "product": "Suricata",
        "type": "ids",
        "vendor": "OISF"
    },
    "related": {
        "hosts": ["{{ domain }}"],
        "ip": ["{{ src_ip }}", "{{ dst_ip }}"]
    },
    "source": {
        "address": "{{ src_ip }}",
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "suricata": {
        "eve": {
            "event_type": "http",
            "flow_id": "{{ fid }}",
            "http": {
                "http_content_type": "{{ content_type }}",
                "protocol": "HTTP/1.1"
            },
            "in_iface": "{{ params.interface }}"
        }
    },
    "tags": ["suricata"],
    "url": {
        "domain": "{{ domain }}",
        "original": "{{ url_path }}",
        "path": "{{ url_path }}"
    },
    "user_agent": {
        "original": "{{ ua }}"
    }
}
