{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{#- Bot user agent — weighted selection -#}
{%- set bot_uas = [] -%}
{%- set bot_weights = [] -%}
{%- for ua in samples.user_agents -%}
  {%- if ua.type == "bot" -%}
    {%- do bot_uas.append(ua) -%}
    {%- do bot_weights.append(ua.weight) -%}
  {%- endif -%}
{%- endfor -%}
{%- set ua = module.rand.weighted_choice(bot_uas, bot_weights) -%}
{#- Bots crawl pages, robots.txt, sitemap.xml -#}
{%- set bot_paths = [
    "/", "/about", "/contact", "/products", "/blog",
    "/products/catalog", "/faq", "/terms", "/privacy",
    "/blog/2025/getting-started", "/blog/2025/new-features",
    "/blog/2025/best-practices", "/login", "/register",
    "/robots.txt", "/sitemap.xml"
] -%}
{%- set url_path = bot_paths | random -%}
{#- Status — mostly successful, some redirects and 404s -#}
{%- set status = module.rand.weighted_choice([200, 301, 304, 404], [75, 10, 5, 10]) -%}
{#- Response size -#}
{%- if status == 304 -%}
  {%- set body_bytes = 0 -%}
{%- elif status == 404 -%}
  {%- set body_bytes = module.rand.number.integer(200, 800) -%}
{%- elif status == 301 -%}
  {%- set body_bytes = module.rand.number.integer(200, 500) -%}
{%- elif url_path == "/robots.txt" -%}
  {%- set body_bytes = module.rand.number.integer(100, 500) -%}
{%- elif url_path == "/sitemap.xml" -%}
  {%- set body_bytes = module.rand.number.integer(2000, 50000) -%}
{%- else -%}
  {%- set body_bytes = module.rand.number.integer(5000, 30000) -%}
{%- endif -%}
{#- Bot IPs are always public -#}
{%- set source_address = module.rand.network.ip_v4_public() -%}
{%- set response_time = module.rand.number.integer(5000, 300000) -%}
{#- Event outcome based on status -#}
{%- if status >= 400 -%}
  {%- set outcome = "failure" -%}
{%- else -%}
  {%- set outcome = "success" -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "apache": {
        "access": {
            "remote_addresses": ["{{ source_address }}"],
            "response_time": {{ response_time }}
        }
    },
    "data_stream": {
        "dataset": "apache.access",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "apache.access",
        "kind": "event",
        "module": "apache",
        "outcome": "{{ outcome }}"
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}",
        "os": {
            "family": "{{ params.os_family }}",
            "name": "{{ params.os_name }}",
            "type": "linux"
        }
    },
    "http": {
        "request": {
            "method": "GET"
        },
        "response": {
            "body": {
                "bytes": {{ body_bytes }}
            },
            "status_code": {{ status }}
        },
        "version": "1.1"
    },
    "related": {
        "ip": ["{{ source_address }}"]
    },
    "source": {
        "address": "{{ source_address }}",
        "ip": "{{ source_address }}"
    },
    "tags": ["apache-access"],
    "url": {
{% if url_path.endswith(".txt") %}
        "extension": "txt",
{% elif url_path.endswith(".xml") %}
        "extension": "xml",
{% endif %}
        "domain": "{{ domain }}",
        "original": "{{ url_path }}",
        "path": "{{ url_path }}"
    },
    "user_agent": {
        "device": {
            "name": "{{ ua.device }}"
        },
        "name": "{{ ua.name }}",
        "original": "{{ ua.original }}",
        "version": "{{ ua.version }}"
    }
}
