{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{#- Redirect paths — old URLs redirecting to new locations -#}
{%- set redirect_paths = [
    {
        "from": "/home",
        "to": "/"
    },
    {
        "from": "/info",
        "to": "/about"
    },
    {
        "from": "/catalogue",
        "to": "/products/catalog"
    },
    {
        "from": "/news",
        "to": "/blog"
    },
    {
        "from": "/signin",
        "to": "/login"
    },
    {
        "from": "/signup",
        "to": "/register"
    },
    {
        "from": "/help",
        "to": "/faq"
    },
    {
        "from": "/articles",
        "to": "/blog"
    },
    {
        "from": "/shop",
        "to": "/products"
    },
    {
        "from": "/support",
        "to": "/contact"
    },
    {
        "from": "/old-page",
        "to": "/about"
    },
    {
        "from": "http://" ~ domain ~ "/",
        "to": "https://" ~ domain ~ "/"
    }
] -%}
{%- set redirect = redirect_paths | random -%}
{#- 301 (permanent) more common than 302 (temporary) -#}
{%- set status = module.rand.weighted_choice([301, 302], [70, 30]) -%}
{#- Redirect body is small (HTML redirect notice) -#}
{%- set body_bytes = module.rand.number.integer(200, 600) -%}
{#- Source IP -#}
{%- set source_address = module.rand.weighted_choice(
    [module.rand.network.ip_v4_private_c(), module.rand.network.ip_v4_public()],
    [30, 70]
) -%}
{#- User agent — browsers and bots both get redirects -#}
{%- set ua = samples.user_agents | random -%}
{%- set response_time = module.rand.number.integer(500, 5000) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "apache": {
        "access": {
            "remote_addresses": ["{{ source_address }}"],
            "response_time": {{ response_time }}
        }
    },
    "data_stream": {
        "dataset": "apache.access",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "apache.access",
        "kind": "event",
        "module": "apache",
        "outcome": "success"
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}",
        "os": {
            "family": "{{ params.os_family }}",
            "name": "{{ params.os_name }}",
            "type": "linux"
        }
    },
    "http": {
        "request": {
            "method": "GET"
        },
        "response": {
            "body": {
                "bytes": {{ body_bytes }}
            },
            "status_code": {{ status }}
        },
        "version": "1.1"
    },
    "related": {
        "ip": ["{{ source_address }}"]
    },
    "source": {
        "address": "{{ source_address }}",
        "ip": "{{ source_address }}"
    },
    "tags": ["apache-access"],
    "url": {
        "domain": "{{ domain }}",
        "original": "{{ redirect.from }}",
        "path": "{{ redirect.from }}"
    },
    "user_agent": {
        "device": {
            "name": "{{ ua.device }}"
        },
        "name": "{{ ua.name }}",
        "original": "{{ ua.original }}",
{% if ua.os_name != "Other" %}
        "os": {
            "full": "{{ ua.os_full }}",
            "name": "{{ ua.os_name }}",
            "version": "{{ ua.os_version }}"
        },
{% endif %}
        "version": "{{ ua.version }}"
    }
}
