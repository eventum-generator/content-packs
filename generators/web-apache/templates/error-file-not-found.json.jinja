{%- set hostname = params.hostname -%}
{%- set domain = params.domain -%}
{%- set pid = module.rand.number.integer(1000, 65535) -%}
{%- set tid = module.rand.number.integer(140000000000000, 140999999999999) -%}
{#- Try to consume from the 404 pool for correlation with access-client-error -#}
{%- set not_found_pool = shared.get('not_found_pool', []) -%}
{%- if not_found_pool | length > 0 -%}
  {%- set entry = not_found_pool.pop(0) -%}
  {%- do shared.set('not_found_pool', not_found_pool) -%}
  {%- set file_path = entry.path -%}
  {%- set client_ip = entry.client_ip -%}
{%- else -%}
  {#- Fallback: generate standalone values -#}
  {%- set missing_files = [
      "/var/www/html/wp-admin",
      "/var/www/html/favicon.ico",
      "/var/www/html/apple-touch-icon.png",
      "/var/www/html/apple-touch-icon-precomposed.png",
      "/var/www/html/.env",
      "/var/www/html/xmlrpc.php",
      "/var/www/html/phpmyadmin",
      "/var/www/html/admin",
      "/var/www/html/old-page.html",
      "/var/www/html/images/missing.png"
  ] -%}
  {%- set file_path = missing_files | random -%}
  {%- set client_ip = module.rand.network.ip_v4_public() -%}
{%- endif -%}
{#- Build the error message -#}
{%- if module.rand.chance(0.3) -%}
  {%- set referrer = module.rand.choice([
      "https://" ~ domain ~ "/",
      "https://www.google.com/search?q=site:" ~ domain,
      "https://" ~ domain ~ "/blog"
  ]) -%}
  {%- set message = "File does not exist: " ~ file_path ~ ", referer: " ~ referrer -%}
{%- else -%}
  {%- set message = "File does not exist: " ~ file_path -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "apache": {
        "error": {
            "module": "core"
        }
    },
    "data_stream": {
        "dataset": "apache.error",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "apache.error",
        "kind": "event",
        "module": "apache",
        "type": ["error"]
    },
    "file": {
        "path": "{{ file_path }}"
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}",
        "os": {
            "family": "{{ params.os_family }}",
            "name": "{{ params.os_name }}",
            "type": "linux"
        }
    },
    "log": {
        "level": "error"
    },
    "message": "{{ message }}",
    "process": {
        "pid": {{ pid }},
        "thread": {
            "id": {{ tid }}
        }
    },
    "source": {
        "address": "{{ client_ip }}",
        "ip": "{{ client_ip }}"
    },
    "tags": ["apache-error"]
}
