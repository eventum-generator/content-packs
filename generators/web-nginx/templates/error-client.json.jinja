{%- set hostname = params.hostname -%}
{%- set server_name = params.server_name -%}
{%- set conn_id = shared.get('conn_id', 1000) -%}
{%- set pid = params.get('nginx_pid', 1234) -%}
{%- set tid = pid -%}
{#- Pick a client error type -#}
{%- set client_errors = samples.error_messages.client -%}
{%- set err = client_errors | random -%}
{#- Source IP -#}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{#- Build message -#}
{%- if "too large body" in err.message_tpl -%}
  {%- set body_size = err.sizes | random -%}
  {%- set msg = err.message_tpl | replace("${size}", body_size | string) -%}
  {%- set req_path = module.rand.choice(["/api/v1/upload", "/api/v1/users", "/contact"]) -%}
  {%- set req_method = "POST" -%}
  {%- set full_message = msg ~ ", client: " ~ src_ip ~ ", server: " ~ server_name ~ ", request: \"" ~ req_method ~ " " ~ req_path ~ " HTTP/1.1\", host: \"" ~ server_name ~ "\"" -%}
{%- elif "prematurely closed" in err.message_tpl -%}
  {%- set msg = err.message_tpl -%}
  {%- set full_message = msg ~ ", client: " ~ src_ip ~ ", server: " ~ server_name -%}
{%- else -%}
  {%- set msg = err.message_tpl -%}
  {%- set full_message = msg ~ ", client: " ~ src_ip ~ ", server: " ~ server_name -%}
{%- endif -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "data_stream": {
        "dataset": "nginx.error",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "nginx.error",
        "kind": "event",
        "module": "nginx",
        "type": ["error"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}"
    },
    "log": {
        "level": "{{ err.level }}"
    },
    "message": {{ full_message | tojson }},
    "nginx": {
        "error": {
            "connection_id": {{ conn_id }}
        }
    },
    "process": {
        "pid": {{ pid }},
        "thread": {
            "id": {{ tid }}
        }
    }
}
{%- do shared.set('conn_id', conn_id + 1) -%}