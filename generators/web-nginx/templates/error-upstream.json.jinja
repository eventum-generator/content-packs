{%- set hostname = params.hostname -%}
{%- set server_name = params.server_name -%}
{%- set upstream_addr = params.upstream_addr -%}
{%- set conn_id = shared.get('conn_id', 1000) -%}
{%- set pid = params.get('nginx_pid', 1234) -%}
{%- set tid = pid -%}
{#- Pick an upstream error -#}
{%- set err = samples.error_messages.upstream | random -%}
{#- Request context -#}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{%- set req_method = module.rand.weighted_choice(["GET", "POST"], [65, 35]) -%}
{%- set req_path = module.rand.choice([
  "/api/v1/users", "/api/v1/products", "/api/v1/orders",
  "/api/v1/search", "/api/v1/auth/login", "/api/v1/health",
  "/dashboard", "/api/v1/metrics"
]) -%}
{%- set upstream_url = "http://" ~ upstream_addr ~ req_path -%}
{#- Build the full error message -#}
{%- set full_message = err.message ~ ", client: " ~ src_ip ~ ", server: " ~ server_name ~ ", request: \"" ~ req_method ~ " " ~ req_path ~ " HTTP/1.1\", upstream: \"" ~ upstream_url ~ "\", host: \"" ~ server_name ~ "\"" -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "data_stream": {
        "dataset": "nginx.error",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "nginx.error",
        "kind": "event",
        "module": "nginx",
        "type": ["error"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}"
    },
    "log": {
        "level": "{{ err.level }}"
    },
    "message": {{ full_message | tojson }},
    "nginx": {
        "error": {
            "connection_id": {{ conn_id }}
        }
    },
    "process": {
        "pid": {{ pid }},
        "thread": {
            "id": {{ tid }}
        }
    }
}
{%- do shared.set('conn_id', conn_id + 1) -%}