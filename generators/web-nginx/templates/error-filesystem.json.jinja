{%- set hostname = params.hostname -%}
{%- set server_name = params.server_name -%}
{%- set doc_root = params.get('doc_root', '/var/www/html') -%}
{%- set conn_id = shared.get('conn_id', 1000) -%}
{%- set pid = params.get('nginx_pid', 1234) -%}
{%- set tid = pid -%}
{#- Pick a filesystem error type -#}
{%- set fs_errors = samples.error_messages.filesystem -%}
{%- set err = fs_errors | random -%}
{%- set err_path = err.paths | random -%}
{#- Build message from template -#}
{%- set msg = err.message_tpl | replace("${doc_root}", doc_root) | replace("${path}", err_path) -%}
{#- Source IP -#}
{%- set src_ip = module.rand.network.ip_v4_public() -%}
{#- Request line -#}
{%- set req_method = "GET" -%}
{%- set full_message = msg ~ ", client: " ~ src_ip ~ ", server: " ~ server_name ~ ", request: \"" ~ req_method ~ " " ~ err_path ~ " HTTP/1.1\", host: \"" ~ server_name ~ "\"" -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "filebeat",
        "version": "{{ params.agent_version }}"
    },
    "data_stream": {
        "dataset": "nginx.error",
        "namespace": "default",
        "type": "logs"
    },
    "ecs": {
        "version": "8.11.0"
    },
    "event": {
        "category": ["web"],
        "dataset": "nginx.error",
        "kind": "event",
        "module": "nginx",
        "type": ["error"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}"
    },
    "log": {
        "level": "{{ err.level }}"
    },
    "message": {{ full_message | tojson }},
    "nginx": {
        "error": {
            "connection_id": {{ conn_id }}
        }
    },
    "process": {
        "pid": {{ pid }},
        "thread": {
            "id": {{ tid }}
        }
    }
}
{%- do shared.set('conn_id', conn_id + 1) -%}