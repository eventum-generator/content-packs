{%- set record_id = shared.get('record_id', 1) -%}
{%- set hostname = params.hostname -%}
{%- set dns_server = params.dns_server_ip -%}
{%- set internal_domain = params.internal_domain -%}
{#- Client selection -#}
{%- set src_ip = module.rand.network.ip_v4_private_c() -%}
{%- set src_port = module.rand.number.integer(49152, 65535) -%}
{%- set dns_id = module.rand.number.integer(1, 65535) -%}
{#- SRV queries: 90% internal (AD services), 10% external -#}
{%- set is_internal = module.rand.chance(0.90) -%}
{#- SRV service records â€” Active Directory and common protocols -#}
{%- set srv_services = [
  {"service": "_ldap._tcp", "port": 389, "target_prefix": "dc"},
  {"service": "_kerberos._tcp", "port": 88, "target_prefix": "dc"},
  {"service": "_kpasswd._tcp", "port": 464, "target_prefix": "dc"},
  {"service": "_gc._tcp", "port": 3268, "target_prefix": "dc"},
  {"service": "_ldap._tcp.dc._msdcs", "port": 389, "target_prefix": "dc"},
  {"service": "_kerberos._tcp.dc._msdcs", "port": 88, "target_prefix": "dc"},
  {"service": "_sip._tcp", "port": 5060, "target_prefix": "sip"},
  {"service": "_sipfederationtls._tcp", "port": 5061, "target_prefix": "sipfed"},
  {"service": "_xmpp-server._tcp", "port": 5269, "target_prefix": "xmpp"}
] -%}
{%- set srv = module.rand.choice(srv_services) -%}
{%- if is_internal -%}
  {%- set query_name = srv.service ~ "." ~ internal_domain -%}
  {%- set registered_domain = internal_domain -%}
  {%- set tld = internal_domain.split(".")[-1] -%}
  {%- set subdomain = srv.service -%}
  {%- set target1 = srv.target_prefix ~ "01." ~ internal_domain -%}
  {%- set target2 = srv.target_prefix ~ "02." ~ internal_domain -%}
{%- else -%}
  {%- set domain = samples.domains | random -%}
  {%- set query_name = srv.service ~ "." ~ domain.registered_domain -%}
  {%- set registered_domain = domain.registered_domain -%}
  {%- set tld = domain.tld -%}
  {%- set subdomain = srv.service -%}
  {%- set target1 = srv.target_prefix ~ "01." ~ domain.registered_domain -%}
  {%- set target2 = srv.target_prefix ~ "02." ~ domain.registered_domain -%}
{%- endif -%}
{#- Number of SRV records: 1-2 -#}
{%- set srv_count = module.rand.weighted_choice([1, 2], [40, 60]) -%}
{#- Response code -#}
{%- set rcode = module.rand.weighted_choice(["NOERROR", "NXDOMAIN", "SERVFAIL"], [80, 15, 5]) -%}
{#- Timing -#}
{%- set duration_ns = module.rand.number.integer(1000000, 60000000) -%}
{%- set duration_td = module.datetime.timedelta(microseconds=duration_ns // 1000) -%}
{%- set end_ts = timestamp + duration_td -%}
{#- Byte sizes -#}
{%- set query_bytes = 12 + (query_name | length) + 6 -%}
{%- if rcode == "NOERROR" -%}
  {%- set response_bytes = query_bytes + srv_count * (18 + (target1 | length)) -%}
{%- else -%}
  {%- set response_bytes = query_bytes + 6 -%}
{%- endif -%}
{#- Transport -#}
{%- set transport = module.rand.weighted_choice(["udp", "tcp"], [95, 5]) -%}
{#- Community ID -#}
{%- set _cid = module.hashlib.sha1((src_ip ~ ":" ~ src_port ~ ">" ~ dns_server ~ ":53").encode()).digest() -%}
{%- set community_id = "1:" ~ module.base64.b64encode(_cid).decode() -%}
{#- Header flags -#}
{%- set is_authoritative = is_internal and rcode == "NOERROR" -%}
{%- if is_authoritative -%}
  {%- set header_flags = ["AA", "RD", "RA"] -%}
{%- else -%}
  {%- set header_flags = ["RD", "RA"] -%}
{%- endif -%}
{#- Status -#}
{%- set status = "OK" if rcode == "NOERROR" else "Error" -%}
{%- set answers_count = srv_count if rcode == "NOERROR" else 0 -%}
{%- set ttl = module.rand.weighted_choice([600, 900, 1800, 3600], [25, 30, 30, 15]) -%}
{
    "@timestamp": "{{ timestamp.isoformat() }}",
    "agent": {
        "ephemeral_id": "{{ module.rand.crypto.uuid4() }}",
        "id": "{{ params.agent_id }}",
        "name": "{{ hostname }}",
        "type": "packetbeat",
        "version": "{{ params.agent_version }}"
    },
    "client": {
        "bytes": {{ query_bytes }},
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    },
    "destination": {
        "bytes": {{ response_bytes }},
        "ip": "{{ dns_server }}",
        "port": 53
    },
    "dns": {
{% if rcode == "NOERROR" %}
        "answers": [
            {
                "class": "IN",
                "data": "0 100 {{ srv.port }} {{ target1 }}",
                "name": "{{ query_name }}",
                "ttl": "{{ ttl }}",
                "type": "SRV"
            }{% if srv_count == 2 %},
            {
                "class": "IN",
                "data": "0 100 {{ srv.port }} {{ target2 }}",
                "name": "{{ query_name }}",
                "ttl": "{{ ttl }}",
                "type": "SRV"
            }{% endif %}
        ],
{% else %}
        "answers": [],
{% endif %}
        "header_flags": {{ header_flags | tojson }},
        "id": {{ dns_id }},
        "op_code": "QUERY",
        "question": {
            "class": "IN",
            "name": "{{ query_name }}",
            "registered_domain": "{{ registered_domain }}",
            "subdomain": "{{ subdomain }}",
            "top_level_domain": "{{ tld }}",
            "type": "SRV"
        },
        "response_code": "{{ rcode }}",
        "type": "answer"
    },
    "ecs": {
        "version": "8.17.0"
    },
    "event": {
        "category": ["network"],
        "dataset": "network_traffic.dns",
        "duration": {{ duration_ns }},
        "end": "{{ end_ts.isoformat() }}",
        "kind": "event",
        "module": "network_traffic",
        "start": "{{ timestamp.isoformat() }}",
        "type": ["connection", "protocol"]
    },
    "host": {
        "hostname": "{{ hostname }}",
        "name": "{{ hostname }}"
    },
    "network": {
        "bytes": {{ query_bytes + response_bytes }},
        "community_id": "{{ community_id }}",
        "direction": "unknown",
        "protocol": "dns",
        "transport": "{{ transport }}",
        "type": "ipv4"
    },
    "network_traffic": {
        "dns": {
            "additionals_count": 0,
            "answers_count": {{ answers_count }},
            "authorities_count": 0,
            "flags": {
                "authentic_data": false,
                "authoritative": {{ "true" if is_authoritative else "false" }},
                "checking_disabled": false,
                "recursion_available": true,
                "recursion_desired": true,
                "truncated_response": false
            },
            "method": "QUERY",
            "query": "class IN, type SRV, {{ query_name }}",
            "question": {
                "etld_plus_one": "{{ registered_domain }}"
            },
            "resource": "{{ query_name }}"
        },
        "status": "{{ status }}"
    },
    "related": {
        "ip": ["{{ src_ip }}", "{{ dns_server }}"]
    },
    "server": {
        "bytes": {{ response_bytes }},
        "ip": "{{ dns_server }}",
        "port": 53
    },
    "source": {
        "bytes": {{ query_bytes }},
        "ip": "{{ src_ip }}",
        "port": {{ src_port }}
    }
}
{%- do shared.set('record_id', record_id + 1) -%}
